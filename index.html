function downloadShareCard() {
    if (window.currentShareCardData && window.currentShareCardId) {
        const link = document.createElement('a');
        link.download = `confession-${window.currentShareCardId}.png`;
        link.href = window.currentShareCardData;
        link.click();
        
        // Close the modal after download
        closeShareCardModal();
    }
}

function closeShareCardModal() {
    const modal = document.getElementById('share-card-modal');
    modal.style.display = 'none';
    
    // Clean up stored data
    window.currentShareCardData = null;
    window.currentShareCardId = null;
}<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonymous Confessions | Share Your Secrets</title>
<meta name="description" content="Share your anonymous confessions and secrets with the world. A safe space to express yourself freely.">
<meta property="og:title" content="Anonymous Confessions">
<meta property="og:description" content="Share your anonymous confessions and secrets with the world.">
<meta property="og:type" content="website">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root {
    --primary-color: #6c5ce7;
    --primary-light: #a29bfe;
    --primary-dark: #4834d4;
    --accent-color: #fd79a8;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --danger-color: #d63031;
    --text-color: #2d3436;
    --text-light: #636e72;
    --bg-color: #f8f9fa;
    --card-color: #ffffff;
    --border-color: #eee;
    --karma-bronze: #cd7f32;
    --karma-silver: #c0c0c0;
    --karma-gold: #ffd700;
}

[data-theme="dark"] {
    --primary-color: #6c5ce7;
    --primary-light: #a29bfe;
    --primary-dark: #4834d4;
    --accent-color: #fd79a8;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --danger-color: #d63031;
    --text-color: #f5f6fa;
    --text-light: #dcdde1;
    --bg-color: #1e272e;
    --card-color: #2d3436;
    --border-color: #353b48;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Navigation Bar */
.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border-color);
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-container i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.logo-text {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.nav-links {
    display: flex;
    align-items: center;
    gap: 20px;
}

.nav-link {
    color: var(--text-color);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
}

.nav-link:hover {
    color: var(--primary-color);
}

/* Karma Display */
.karma-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--card-color);
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    font-size: 0.9rem;
}

.karma-display i {
    color: var(--karma-gold);
}

/* Leaderboard Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--card-color);
    margin: 5% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.close {
    color: var(--text-light);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--text-color);
}

/* Leaderboard */
.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    gap: 15px;
}

.rank {
    font-weight: bold;
    font-size: 1.2rem;
    width: 30px;
    text-align: center;
}

.rank.gold { color: var(--karma-gold); }
.rank.silver { color: var(--karma-silver); }
.rank.bronze { color: var(--karma-bronze); }

.karma-badge {
    background: var(--primary-light);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-left: auto;
}

/* Share Card Styles */
.share-card {
    background: var(--card-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
    min-height: 200px;
}

.share-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.share-card-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: var(--primary-color);
}

.share-card-content {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 20px;
}

.share-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
}

.qr-code {
    width: 80px;
    height: 80px;
}

/* Reply System Styles */
.replies-section {
    margin-top: 20px;
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
}

.replies-toggle {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 0.9rem;
    padding: 5px 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.replies-toggle:hover {
    text-decoration: underline;
}

.replies-container {
    margin-top: 15px;
    display: none;
}

.replies-container.active {
    display: block;
}

.reply {
    background: rgba(var(--primary-color), 0.05);
    border-left: 3px solid var(--primary-light);
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 0 8px 8px 0;
}

.reply-form {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.reply-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    resize: none;
    background: var(--card-color);
    color: var(--text-color);
}

.reply-submit {
    padding: 8px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}

.reply-submit:hover {
    background: var(--primary-dark);
}

.reply-count {
    color: var(--text-light);
    font-size: 0.8rem;
    margin-left: 5px;
}

/* Notification Badge */
.notification-badge {
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
    position: absolute;
    top: -5px;
    right: -5px;
}

/* Share Options */
.share-options {
    display: none;
    position: absolute;
    background: var(--card-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    right: 0;
    top: 100%;
    margin-top: 5px;
    min-width: 150px;
}

.share-options.active {
    display: block;
}

.share-option-btn {
    display: block;
    width: 100%;
    text-align: left;
    padding: 8px 12px;
    border: none;
    background: none;
    cursor: pointer;
    color: var(--text-color);
    font-size: 0.9rem;
}

.share-option-btn:hover {
    background: var(--bg-color);
}

.share-option-btn i {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

/* Achievement Popup */
.achievement-popup {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success-color);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none;
    animation: slideIn 0.3s ease-out;
    z-index: 1000;
}

.achievement-popup.show {
    display: block;
}

.achievement-popup h4 {
    margin: 0 0 5px 0;
    font-size: 1rem;
}

.achievement-popup p {
    margin: 0;
    font-size: 0.85rem;
    opacity: 0.9;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Stats Dashboard Update */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--card-color);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    position: relative;
    transition: transform 0.3s ease;
}

.stat-card.clickable {
    cursor: pointer;
}

.stat-card.clickable:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    color: var(--text-light);
    font-size: 0.9rem;
}

/* Additional existing styles... */
h1 {
    text-align: center;
    color: var(--primary-color);
    margin: 30px 0;
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
}

h2 {
    color: var(--primary-dark);
    font-size: 1.5rem;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--primary-light);
    padding-bottom: 8px;
    display: flex;
    align-items: center;
}

h2 i {
    margin-right: 10px;
    color: var(--primary-color);
}

.container {
    background-color: var(--card-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    margin-bottom: 30px;
    transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
}

.container:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.1);
}

.rules-banner {
    background-color: #f1f2f6;
    border-left: 4px solid var(--warning-color);
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
}

[data-theme="dark"] .rules-banner {
    background-color: rgba(45, 52, 54, 0.7);
}

.rules-banner h3 {
    margin: 0 0 10px 0;
    color: var(--warning-color);
}

.rules-banner ul {
    margin: 0;
    padding-left: 20px;
}

textarea {
    width: 100%;
    height: 120px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    resize: vertical;
    font-family: inherit;
    margin-bottom: 5px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    transition: border 0.3s ease, box-shadow 0.3s ease;
    font-size: 1rem;
    background-color: var(--card-color);
    color: var(--text-color);
}

textarea:focus {
    border-color: var(--primary-color);
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(108, 92, 231, 0.3);
    outline: none;
}

.textarea-container {
    position: relative;
    margin-bottom: 15px;
}

.character-count {
    position: absolute;
    right: 10px;
    bottom: 5px;
    font-size: 0.8rem;
    color: var(--text-light);
    background-color: rgba(255, 255, 255, 0.8);
    padding: 2px 8px;
    border-radius: 4px;
}

.character-count.warning {
    color: var(--danger-color);
}

[data-theme="dark"] .character-count {
    background-color: rgba(0, 0, 0, 0.5);
}

button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

button i {
    margin-right: 8px;
}

button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
}

button:disabled {
    background-color: var(--text-light);
    cursor: not-allowed;
    transform: none;
}

.button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

#random-confession {
    background-color: var(--primary-light);
}

#random-confession:hover {
    background-color: var(--primary-color);
}

#theme-toggle {
    background-color: #2c3e50;
    position: fixed;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

#theme-toggle i {
    margin: 0;
}

/* Categories */
.category-selector {
    margin-bottom: 20px;
}

.category-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.category-tag {
    padding: 5px 15px;
    border-radius: 20px;
    background-color: var(--primary-light);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.category-tag:hover {
    background-color: var(--primary-color);
}

.category-tag.active {
    background-color: var(--primary-dark);
}

/* Filter Options */
.filter-options {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
}

.filter-select {
    padding: 8px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-color);
    color: var(--text-color);
    font-family: inherit;
}

/* Search Bar */
.search-container {
    position: relative;
    margin-bottom: 20px;
}

.search-input {
    width: 100%;
    padding: 10px 40px 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    background-color: var(--card-color);
    color: var(--text-color);
}

.search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

/* Confession Cards */
.confessions-list {
    display: grid;
    grid-gap: 20px;
}

.confession {
    background-color: var(--card-color);
    padding: 20px;
    border-radius: 10px;
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    animation: fadeIn 0.5s ease-out;
}

.confession:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

.confession.reported {
    opacity: 0.6;
    border-left-color: var(--danger-color);
}

.confession p {
    margin: 0;
    line-height: 1.6;
    font-size: 1.05rem;
}

.confession .meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    flex-wrap: wrap;
    gap: 10px;
}

.confession .timestamp,
.confession .views {
    font-size: 0.8rem;
    color: var(--text-light);
    display: flex;
    align-items: center;
    margin: 0;
}

.timestamp i,
.views i {
    margin-right: 5px;
    font-size: 0.8rem;
}

.meta-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.confession .actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.confession-of-day {
    border: 2px solid #fbc531;
    border-left-width: 6px;
    position: relative;
}

.confession-of-day::before {
    content: "Confession of the Day";
    position: absolute;
    top: -10px;
    left: 10px;
    background-color: #fbc531;
    color: #2d3436;
    padding: 2px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.react-button {
    background: none;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 0 8px;
    margin: 0;
    box-shadow: none;
    color: var(--text-light);
    transition: transform 0.2s ease, color 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    height: 32px;
    min-width: 45px;
    justify-content: center;
}

.react-button:hover {
    transform: scale(1.2);
    background: none;
    box-shadow: none;
    color: var(--primary-color);
}

.react-button.active {
    color: var(--primary-color);
}

/* Color-coded reactions */
.react-button.like i { color: #3b5998; }
.react-button.dislike i { color: #8b0000; }
.react-button.love i { color: #e25b5b; }
.react-button.haha i { color: #f7b928; }
.react-button.wow i { color: #54c7ec; }
.react-button.sad i { color: #8a8d91; }

.reaction-count {
    font-size: 0.85rem;
    margin-left: 2px;
    font-weight: 600;
    color: var(--text-light);
    min-width: 16px;
    text-align: left;
}

.share-button,
.report-button {
    background: none;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    padding: 5px;
    margin: 0;
    box-shadow: none;
    color: var(--text-light);
    transition: transform 0.2s ease, color 0.2s ease;
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 32px;
    min-width: 32px;
}

.share-button:hover {
    background: none;
    box-shadow: none;
    color: var(--primary-color);
}

.report-button:hover {
    background: none;
    box-shadow: none;
    color: var(--danger-color);
}

.admin-action {
    display: none;
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #e74c3c;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.3s ease;
    align-items: center;
    justify-content: center;
}

.admin-mode .admin-action {
    display: flex;
}

.admin-action:hover {
    background-color: #c0392b;
}

.no-confessions {
    text-align: center;
    color: var(--text-light);
    padding: 30px 20px;
    font-style: italic;
    background-color: rgba(255,255,255,0.7);
    border-radius: 10px;
    border: 1px dashed var(--border-color);
}

[data-theme="dark"] .no-confessions {
    background-color: rgba(0,0,0,0.2);
}

.no-confessions i {
    display: block;
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--primary-light);
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 30px;
}

.page-btn {
    padding: 8px 15px;
    border: 1px solid var(--border-color);
    background: var(--card-color);
    color: var(--text-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.page-btn:hover {
    background: var(--primary-light);
    color: white;
    border-color: var(--primary-light);
}

.page-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.page-btn:disabled {
    background: var(--border-color);
    cursor: not-allowed;
    opacity: 0.5;
}

/* Loading States */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
    color: var(--primary-color);
}

.loading i {
    font-size: 2rem;
    animation: spin 1s linear infinite;
}

/* Success Message */
.success-message {
    background-color: var(--success-color);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    align-items: center;
    animation: slideDown 0.3s ease-out;
}

.success-message i {
    margin-right: 10px;
}

/* Error Message */
.error-message {
    background-color: var(--danger-color);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    align-items: center;
    animation: slideDown 0.3s ease-out;
}

.error-message i {
    margin-right: 10px;
}

/* Footer */
footer {
    margin-top: 50px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
    text-align: center;
    color: var(--text-light);
}

footer a {
    color: var(--primary-color);
    text-decoration: none;
}

footer a:hover {
    text-decoration: underline;
}

/* Admin Panel */
#admin-access {
    margin-top: 20px;
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
    display: none;
}

summary {
    cursor: pointer;
    color: var(--text-light);
    font-weight: 500;
    transition: color 0.3s ease;
    display: flex;
    align-items: center;
}

summary:hover {
    color: var(--primary-color);
}

summary i {
    margin-right: 8px;
}

details {
    margin-top: 10px;
}

input[type="password"] {
    padding: 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-right: 10px;
    font-family: inherit;
    font-size: 0.9rem;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    background-color: var(--card-color);
    color: var(--text-color);
}

input[type="password"]:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(108, 92, 231, 0.3);
}

#admin-login {
    background-color: #34495e;
}

#admin-login:hover {
    background-color: #2c3e50;
}

#clear-all {
    background-color: #e74c3c;
    margin-top: 10px;
}

#clear-all:hover {
    background-color: #c0392b;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Responsive Design */
@media (max-width: 600px) {
    body {
        padding: 10px;
    }
    
    .button-group {
        flex-direction: column;
    }
    
    #theme-toggle {
        top: 10px;
        right: 10px;
    }
    
    .category-tags {
        justify-content: center;
    }
    
    .filter-options {
        flex-direction: column;
        align-items: stretch;
    }
    
    .navbar {
        flex-direction: column;
        gap: 10px;
    }
    
    .nav-links {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .confession .meta {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .confession .actions {
        width: 100%;
        justify-content: space-between;
        margin-top: 10px;
    }
    
    .react-button {
        min-width: auto;
        padding: 0 5px;
    }
}
</style>
</head>
<body>
<button id="theme-toggle" aria-label="Toggle dark mode">
<i class="fas fa-moon"></i>
</button>

<nav class="navbar">
<div class="logo-container">
    <i class="fas fa-feather-alt"></i>
    <span class="logo-text">Confessions</span>
</div>
<div class="nav-links">
    <a href="#" class="nav-link" id="home-link">Home</a>
    <a href="#" class="nav-link" id="about-link">About</a>
    <a href="#" class="nav-link" id="rules-link">Rules</a>
    <div class="karma-display" id="karma-display" style="cursor: pointer;">
        <i class="fas fa-star"></i>
        <span id="user-karma">0</span> Karma
    </div>
</div>
</nav>

<h1>Anonymous Confessions</h1>

<div class="stats-container">
<div class="stat-card">
    <div class="stat-number" id="total-confessions">0</div>
    <div class="stat-label">Total Confessions</div>
</div>
<div class="stat-card">
    <div class="stat-number" id="today-confessions">0</div>
    <div class="stat-label">Today's Confessions</div>
</div>
<div class="stat-card clickable" id="leaderboard-card">
    <div class="stat-number" id="active-users">0</div>
    <div class="stat-label">Top Contributors</div>
</div>
</div>

<div id="confession-of-day-container"></div>

<div class="container confession-form">
<h2><i class="fas fa-comment-dots"></i> Share Your Confession</h2>

<div class="rules-banner">
    <h3><i class="fas fa-exclamation-triangle"></i> Community Guidelines</h3>
    <ul>
        <li>Be respectful - no hate speech or harassment</li>
        <li>Keep it legal - no criminal confessions</li>
        <li>Your confession is anonymous and safe</li>
    </ul>
</div>

<div class="success-message" id="success-message">
    <i class="fas fa-check-circle"></i>
    Your confession has been submitted successfully!
</div>

<div class="error-message" id="error-message">
    <i class="fas fa-exclamation-circle"></i>
    <span id="error-text">An error occurred. Please try again.</span>
</div>

<form id="confession-form">
    <div class="category-selector">
        <label for="category">Category (optional):</label>
        <div class="category-tags">
            <span class="category-tag" data-category="all">All</span>
            <span class="category-tag" data-category="funny">Funny</span>
            <span class="category-tag" data-category="serious">Serious</span>
            <span class="category-tag" data-category="relationships">Relationships</span>
            <span class="category-tag" data-category="work">Work</span>
            <span class="category-tag" data-category="family">Family</span>
            <span class="category-tag" data-category="secret">Secret</span>
        </div>
    </div>
    
    <div class="textarea-container">
        <textarea id="confession-text" placeholder="Type your confession here... (anonymous)" required maxlength="1000"></textarea>
        <div class="character-count">0/1000 characters</div>
    </div>
    <button type="submit" id="submit-btn"><i class="fas fa-paper-plane"></i> Submit Confession</button>
</form>
<div class="button-group">
    <button id="random-confession"><i class="fas fa-random"></i> Random Confession</button>
</div>
<div id="admin-access">
    <details>
        <summary><i class="fas fa-lock"></i> Admin Access</summary>
        <div style="margin-top: 15px;">
            <input type="password" id="admin-password" placeholder="Enter admin password">
            <button id="admin-login"><i class="fas fa-sign-in-alt"></i> Login</button>
            <div id="admin-panel" style="margin-top: 10px; display: none;">
                <button id="clear-all"><i class="fas fa-trash-alt"></i> Clear All Confessions</button>
            </div>
        </div>
    </details>
</div>
</div>

<div class="container">
<h2><i class="fas fa-book-open"></i> Recent Confessions</h2>

<div class="search-container">
    <input type="text" class="search-input" id="search-input" placeholder="Search confessions...">
    <i class="fas fa-search search-icon"></i>
</div>

<div class="filter-options">
    <select class="filter-select" id="sort-select">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="popular">Most Popular</option>
    </select>
    <select class="filter-select" id="category-filter">
        <option value="all">All Categories</option>
        <option value="funny">Funny</option>
        <option value="serious">Serious</option>
        <option value="relationships">Relationships</option>
        <option value="work">Work</option>
        <option value="family">Family</option>
        <option value="secret">Secret</option>
    </select>
</div>

<div id="confessions-list" class="confessions-list">
    <div class="loading">
        <i class="fas fa-spinner"></i>
    </div>
</div>

<div class="pagination" id="pagination"></div>
</div>

<footer>
<p>&copy; 2024 Anonymous Confessions. All rights reserved.</p>
<p><a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a> | <a href="#">Contact Us</a></p>
</footer>

<!-- Modals -->
<div id="leaderboard-modal" class="modal">
<div class="modal-content">
    <span class="close">&times;</span>
    <h2><i class="fas fa-trophy"></i> Top Contributors</h2>
    <div id="leaderboard-content">
        <div class="loading">
            <i class="fas fa-spinner"></i>
        </div>
    </div>
</div>
</div>

<div id="share-card-modal" class="modal">
<div class="modal-content">
    <span class="close" onclick="closeShareCardModal()">&times;</span>
    <h2><i class="fas fa-image"></i> Share Card Preview</h2>
    <div id="share-card-preview"></div>
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="downloadShareCard()" style="background-color: var(--success-color); margin-right: 10px;">
            <i class="fas fa-download"></i> Download Card
        </button>
        <button onclick="closeShareCardModal()" style="background-color: var(--text-light);">
            <i class="fas fa-times"></i> Cancel
        </button>
    </div>
</div>
</div>

<div id="achievement-popup" class="achievement-popup">
<h4 id="achievement-title"></h4>
<p id="achievement-description"></p>
</div>

<!-- Share Card Canvas (hidden) -->
<div id="share-card-canvas" style="position: absolute; left: -9999px; top: -9999px;">
<div class="share-card" style="width: 600px; background: white;">
    <div class="share-card-header">
        <div class="share-card-logo">
            <i class="fas fa-feather-alt"></i>
            <span>Anonymous Confessions</span>
        </div>
        <div id="share-card-date"></div>
    </div>
    <div class="share-card-content" id="share-card-text"></div>
    <div class="share-card-footer">
        <div id="share-card-stats"></div>
        <div id="share-card-qr" class="qr-code"></div>
    </div>
</div>
</div>

<script>
// Configuration
const CONFESSIONS_PER_PAGE = 10;
const MAX_CONFESSION_LENGTH = 1000;
const AUTO_ARCHIVE_DAYS = 30;
const FORBIDDEN_WORDS = ['hate', 'kill', 'racist', 'sexist'];

// Karma & Achievement System Configuration
const KARMA_POINTS = {
    submitConfession: 10,
    receiveReaction: 1,
    receiveReply: 2,
    receiveLove: 3,
    dailyConfession: 5,
    popularConfession: 20  // 50+ reactions
};

const ACHIEVEMENTS = {
    firstConfession: {
        id: 'first_confession',
        title: 'First Steps',
        description: 'Submit your first confession',
        karma: 50
    },
    popularConfession: {
        id: 'popular_confession',
        title: 'Crowd Favorite',
        description: 'Get 50+ reactions on a confession',
        karma: 100
    },
    dailyStreak: {
        id: 'daily_streak',
        title: 'Regular Contributor',
        description: 'Submit confessions 7 days in a row',
        karma: 200
    },
    conversationStarter: {
        id: 'conversation_starter',
        title: 'Conversation Starter',
        description: 'Get 10+ replies on a confession',
        karma: 150
    },
    karmaLegend: {
        id: 'karma_legend',
        title: 'Karma Legend',
        description: 'Reach 1000 karma points',
        karma: 500
    }
};

// State management
let currentPage = 1;
let currentCategory = 'all';
let currentSort = 'newest';
let searchQuery = '';
let selectedCategory = null;
let isSubmitting = false;
let userKarma = 0;
let userAchievements = [];
let userId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // Initialize user ID
    userId = localStorage.getItem('userId');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
    }
    
    // Load user data
    loadUserData();
    
    // Theme management
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeToggleIcon(savedTheme);
    
    // Event listeners
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('confession-form').addEventListener('submit', handleConfessionSubmit);
    document.getElementById('random-confession').addEventListener('click', showRandomConfession);
    document.getElementById('admin-login').addEventListener('click', handleAdminLogin);
    document.getElementById('clear-all').addEventListener('click', clearAllConfessions);
    document.getElementById('search-input').addEventListener('input', handleSearch);
    document.getElementById('sort-select').addEventListener('change', handleSortChange);
    document.getElementById('category-filter').addEventListener('change', handleCategoryFilterChange);
    document.getElementById('karma-display').addEventListener('click', showLeaderboard);
    document.getElementById('leaderboard-card').addEventListener('click', showLeaderboard);
    
    // Close modal when clicking outside
    document.getElementById('leaderboard-modal').addEventListener('click', function(e) {
        if (e.target.className === 'modal') {
            this.style.display = 'none';
        }
    });
    
    document.getElementById('share-card-modal').addEventListener('click', function(e) {
        if (e.target.className === 'modal') {
            closeShareCardModal();
        }
    });
    
    // Close modal buttons
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal.id === 'share-card-modal') {
                closeShareCardModal();
            } else {
                modal.style.display = 'none';
            }
        });
    });
    
    // Category tags
    document.querySelectorAll('.category-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            selectedCategory = this.dataset.category === 'all' ? null : this.dataset.category;
        });
    });
    
    // Character count
    const textArea = document.getElementById('confession-text');
    const charCount = document.querySelector('.character-count');
    
    textArea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = `${count}/${MAX_CONFESSION_LENGTH} characters`;
        
        if (count > MAX_CONFESSION_LENGTH * 0.9) {
            charCount.classList.add('warning');
        } else {
            charCount.classList.remove('warning');
        }
    });
    
    // Navigation links
    document.getElementById('home-link').addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    document.getElementById('about-link').addEventListener('click', (e) => {
        e.preventDefault();
        alert('Anonymous Confessions - A safe space to share your thoughts anonymously. Created with love for the community.');
    });
    
    document.getElementById('rules-link').addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelector('.rules-banner').scrollIntoView({ behavior: 'smooth' });
    });
    
    // Check if admin access should be visible
    const isAdmin = sessionStorage.getItem('isAdmin');
    if (isAdmin) {
        document.getElementById('admin-access').style.display = 'block';
    }
    
    // Initial load
    loadConfessions();
    setConfessionOfDay();
    updateStatistics();
    autoArchiveOldConfessions();
    checkSharedConfession();
    
    // Update stats every minute
    setInterval(updateStatistics, 60000);
    
    // Check for daily streak
    checkDailyStreak();
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeToggleIcon(newTheme);
}

function updateThemeToggleIcon(theme) {
    const iconElement = document.querySelector('#theme-toggle i');
    if (theme === 'dark') {
        iconElement.className = 'fas fa-sun';
    } else {
        iconElement.className = 'fas fa-moon';
    }
}

function loadUserData() {
    const userData = localStorage.getItem('userData_' + userId);
    if (userData) {
        const data = JSON.parse(userData);
        userKarma = data.karma || 0;
        userAchievements = data.achievements || [];
    }
    updateKarmaDisplay();
}

function saveUserData() {
    const userData = {
        karma: userKarma,
        achievements: userAchievements,
        lastSubmissionDate: new Date().toDateString()
    };
    localStorage.setItem('userData_' + userId, JSON.stringify(userData));
}

function updateKarmaDisplay() {
    document.getElementById('user-karma').textContent = userKarma;
}

function addKarma(points, reason) {
    userKarma += points;
    updateKarmaDisplay();
    saveUserData();
    checkAchievements();
}

function showAchievement(achievement) {
    const popup = document.getElementById('achievement-popup');
    document.getElementById('achievement-title').textContent = achievement.title;
    document.getElementById('achievement-description').textContent = achievement.description;
    
    popup.classList.add('show');
    
    setTimeout(() => {
        popup.classList.remove('show');
    }, 5000);
}

function checkAchievements() {
    // Check for first confession achievement
    const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const userConfessions = confessions.filter(c => c.userId === userId);
    
    if (userConfessions.length === 1 && !userAchievements.includes('first_confession')) {
        userAchievements.push('first_confession');
        addKarma(ACHIEVEMENTS.firstConfession.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.firstConfession);
    }
    
    // Check for karma legend achievement
    if (userKarma >= 1000 && !userAchievements.includes('karma_legend')) {
        userAchievements.push('karma_legend');
        addKarma(ACHIEVEMENTS.karmaLegend.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.karmaLegend);
    }
    
    saveUserData();
}

function checkDailyStreak() {
    const userData = localStorage.getItem('userData_' + userId);
    if (userData) {
        const data = JSON.parse(userData);
        const lastSubmission = data.lastSubmissionDate;
        const today = new Date().toDateString();
        
        if (lastSubmission && lastSubmission !== today) {
            // Check if it's consecutive days
            const lastDate = new Date(lastSubmission);
            const diffTime = Math.abs(new Date() - lastDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                // Consecutive day
                const currentStreak = (data.currentStreak || 0) + 1;
                data.currentStreak = currentStreak;
                
                if (currentStreak === 7 && !userAchievements.includes('daily_streak')) {
                    userAchievements.push('daily_streak');
                    addKarma(ACHIEVEMENTS.dailyStreak.karma, 'achievement');
                    showAchievement(ACHIEVEMENTS.dailyStreak);
                }
            } else {
                // Streak broken
                data.currentStreak = 0;
            }
            
            localStorage.setItem('userData_' + userId, JSON.stringify(data));
        }
    }
}

function handleConfessionSubmit(e) {
    e.preventDefault();
    
    if (isSubmitting) return;
    
    const confessionText = document.getElementById('confession-text').value.trim();
    const submitBtn = document.getElementById('submit-btn');
    
    if (confessionText) {
        // Basic content moderation
        if (containsForbiddenWords(confessionText)) {
            showErrorMessage('Your confession contains inappropriate content. Please revise and try again.');
            return;
        }
        
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        // Simulate API call
        setTimeout(() => {
            if (addConfession(confessionText, selectedCategory)) {
                document.getElementById('confession-text').value = '';
                document.querySelector('.character-count').textContent = '0/1000 characters';
                showSuccessMessage();
                
                // Reset category selection
                document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
                document.querySelector('.category-tag[data-category="all"]').classList.add('active');
                selectedCategory = null;
                
                // Add karma for submission
                addKarma(KARMA_POINTS.submitConfession, 'submission');
            }
            
            isSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Confession';
        }, 1000);
    }
}

function containsForbiddenWords(text) {
    const lowerText = text.toLowerCase();
    return FORBIDDEN_WORDS.some(word => lowerText.includes(word));
}

function showSuccessMessage() {
    const successMessage = document.getElementById('success-message');
    successMessage.style.display = 'flex';
    
    setTimeout(() => {
        successMessage.style.display = 'none';
    }, 3000);
}

function showErrorMessage(message) {
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    errorText.textContent = message;
    errorMessage.style.display = 'flex';
    
    setTimeout(() => {
        errorMessage.style.display = 'none';
    }, 3000);
}

function addConfession(text, category = null) {
    try {
        const confession = {
            id: 'conf_' + Date.now(),
            userId: userId,
            text: text,
            category: category,
            timestamp: new Date().toISOString(),
            views: 0,
            reactions: {
                like: 0,
                dislike: 0,
                love: 0,
                haha: 0,
                wow: 0,
                sad: 0
            },
            replies: [],
            reports: 0,
            reported: false
        };
        
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        confessions.unshift(confession);
        
        localStorage.setItem('confessions', JSON.stringify(confessions));
        
        loadConfessions();
        updateStatistics();
        checkDailyStreak();
        checkAchievements();
        
        // Check if we need to set a new confession of the day
        const lastUpdate = localStorage.getItem('last_cotd_update');
        if (!lastUpdate) {
            setConfessionOfDay();
        }
        
        return true;
    } catch (error) {
        console.error("Error adding confession:", error);
        showErrorMessage("There was an error saving your confession. Please try again.");
        return false;
    }
}

function loadConfessions() {
    try {
        const confessionsContainer = document.getElementById('confessions-list');
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        
        // Apply filters
        confessions = applyFilters(confessions);
        
        // Calculate pagination
        const totalPages = Math.ceil(confessions.length / CONFESSIONS_PER_PAGE);
        const start = (currentPage - 1) * CONFESSIONS_PER_PAGE;
        const end = start + CONFESSIONS_PER_PAGE;
        const pageConfessions = confessions.slice(start, end);
        
        if (pageConfessions.length === 0) {
            confessionsContainer.innerHTML = '<div class="no-confessions"><i class="fas fa-feather"></i>No confessions found.</div>';
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        
        confessionsContainer.innerHTML = '';
        
        pageConfessions.forEach(confession => {
            const confessionElement = createConfessionElement(confession);
            confessionsContainer.appendChild(confessionElement);
            incrementViewCount(confession.id);
        });
        
        // Create pagination
        createPagination(totalPages);
    } catch (error) {
        console.error("Error in loadConfessions:", error);
        document.getElementById('confessions-list').innerHTML = '<div class="error">Error loading confessions. Please refresh the page.</div>';
    }
}

function applyFilters(confessions) {
    let filtered = [...confessions];
    
    // Category filter
    if (currentCategory !== 'all') {
        filtered = filtered.filter(c => c.category === currentCategory);
    }
    
    // Search filter
    if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(c => c.text.toLowerCase().includes(query));
    }
    
    // Sort
    switch (currentSort) {
        case 'oldest':
            filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            break;
        case 'popular':
            filtered.sort((a, b) => {
                const aReactions = Object.values(a.reactions || {}).reduce((sum, val) => sum + val, 0);
                const bReactions = Object.values(b.reactions || {}).reduce((sum, val) => sum + val, 0);
                return bReactions - aReactions;
            });
            break;
        default: // newest
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }
    
    return filtered;
}

function createConfessionElement(confession) {
    const confessionElement = document.createElement('div');
    confessionElement.className = `confession ${confession.reported ? 'reported' : ''}`;
    confessionElement.setAttribute('data-id', confession.id);
    
    const categoryBadge = confession.category ? 
        `<span class="category-badge" style="background-color: var(--primary-light); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block;">${confession.category}</span>` : '';
    
    const totalReactions = Object.values(confession.reactions || {}).reduce((sum, val) => sum + val, 0);
    
    confessionElement.innerHTML = `
        ${categoryBadge}
        <p>${confession.text}</p>
        <div class="meta">
            <div class="meta-info">
                <div class="timestamp">
                    <i class="far fa-clock"></i> ${formatDate(new Date(confession.timestamp))}
                </div>
                <div class="views">
                    <i class="far fa-eye"></i> ${confession.views || 0} views
                </div>
            </div>
            <div class="actions">
                ${createReactionButtons(confession)}
                <button class="share-button" onclick="openShareOptions(event, '${confession.id}')">
                    <i class="fas fa-share-alt"></i>
                </button>
                <div class="share-options" id="share-options-${confession.id}">
                    <button class="share-option-btn" onclick="shareToTwitter('${confession.id}')">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="share-option-btn" onclick="copyShareLink('${confession.id}')">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                    <button class="share-option-btn" onclick="createShareCard('${confession.id}')">
                        <i class="fas fa-image"></i> Create Card
                    </button>
                </div>
                <button class="report-button" onclick="reportConfession('${confession.id}')">
                    <i class="fas fa-flag"></i>
                </button>
            </div>
        </div>
        ${createRepliesSection(confession)}
        <button class="admin-action" onclick="deleteConfession('${confession.id}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Check if this confession is popular enough for achievement
    if (totalReactions >= 50 && confession.userId === userId && !userAchievements.includes('popular_confession')) {
        userAchievements.push('popular_confession');
        addKarma(ACHIEVEMENTS.popularConfession.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.popularConfession);
    }
    
    return confessionElement;
}

function createReactionButtons(confession) {
    const reactions = [
        { name: 'like', icon: 'fas fa-thumbs-up' },
        { name: 'dislike', icon: 'fas fa-thumbs-down' },
        { name: 'love', icon: 'fas fa-heart' },
        { name: 'haha', icon: 'fas fa-laugh' },
        { name: 'wow', icon: 'fas fa-surprise' },
        { name: 'sad', icon: 'fas fa-sad-tear' }
    ];
    
    return reactions.map(reaction => {
        const count = confession.reactions ? (confession.reactions[reaction.name] || 0) : 0;
        return `<button class="react-button ${reaction.name}" onclick="reactToConfession('${confession.id}', '${reaction.name}')">
            <i class="${reaction.icon}"></i> <span class="reaction-count">${count}</span>
        </button>`;
    }).join('');
}

function createRepliesSection(confession) {
    const replies = confession.replies || [];
    const replyCount = replies.length;
    
    return `
        <div class="replies-section">
            <button class="replies-toggle" onclick="toggleReplies('${confession.id}')">
                <i class="fas fa-comments"></i>
                Replies <span class="reply-count">(${replyCount})</span>
            </button>
            <div class="replies-container" id="replies-${confession.id}">
                ${replies.map(reply => `
                    <div class="reply">
                        <p>${reply.text}</p>
                        <div class="reply-meta">
                            <span class="reply-timestamp">${formatDate(new Date(reply.timestamp))}</span>
                        </div>
                    </div>
                `).join('')}
                <div class="reply-form">
                    <textarea class="reply-input" placeholder="Write a reply..." id="reply-input-${confession.id}"></textarea>
                    <button class="reply-submit" onclick="submitReply('${confession.id}')">Reply</button>
                </div>
            </div>
        </div>
    `;
}

function toggleReplies(confessionId) {
    const repliesContainer = document.getElementById(`replies-${confessionId}`);
    repliesContainer.classList.toggle('active');
}

function submitReply(confessionId) {
    const replyInput = document.getElementById(`reply-input-${confessionId}`);
    const replyText = replyInput.value.trim();
    
    if (!replyText) return;
    
    const reply = {
        id: 'reply_' + Date.now(),
        text: replyText,
        timestamp: new Date().toISOString(),
        userId: userId
    };
    
    let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const confessionIndex = confessions.findIndex(c => c.id === confessionId);
    
    if (confessionIndex !== -1) {
        if (!confessions[confessionIndex].replies) {
            confessions[confessionIndex].replies = [];
        }
        
        confessions[confessionIndex].replies.push(reply);
        localStorage.setItem('confessions', JSON.stringify(confessions));
        
        // Add karma to the confession owner if they receive a reply
        const confessionOwner = confessions[confessionIndex].userId;
        if (confessionOwner && confessionOwner !== userId) {
            addKarmaToUser(confessionOwner, KARMA_POINTS.receiveReply);
        }
        
        // Check for conversation starter achievement
        if (confessions[confessionIndex].replies.length >= 10 && 
            confessions[confessionIndex].userId === userId && 
            !userAchievements.includes('conversation_starter')) {
            userAchievements.push('conversation_starter');
            addKarma(ACHIEVEMENTS.conversationStarter.karma, 'achievement');
            showAchievement(ACHIEVEMENTS.conversationStarter);
        }
        
        loadConfessions();
        replyInput.value = '';
    }
}

function addKarmaToUser(targetUserId, points) {
    const userData = localStorage.getItem('userData_' + targetUserId);
    if (userData) {
        const data = JSON.parse(userData);
        data.karma = (data.karma || 0) + points;
        localStorage.setItem('userData_' + targetUserId, JSON.stringify(data));
    }
}

function openShareOptions(event, confessionId) {
    event.stopPropagation();
    const shareOptions = document.getElementById(`share-options-${confessionId}`);
    
    // Close all other share options
    document.querySelectorAll('.share-options').forEach(el => {
        if (el !== shareOptions) {
            el.classList.remove('active');
        }
    });
    
    shareOptions.classList.toggle('active');
    
    // Position the share options properly
    const button = event.currentTarget;
    const rect = button.getBoundingClientRect();
    shareOptions.style.top = `${button.offsetHeight + 5}px`;
    shareOptions.style.right = '0';
    
    // Close share options when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function closeShareOptions(e) {
            if (!shareOptions.contains(e.target) && e.target !== button) {
                shareOptions.classList.remove('active');
                document.removeEventListener('click', closeShareOptions);
            }
        });
    }, 100);
}

function shareToTwitter(confessionId) {
    const confession = getConfessionById(confessionId);
    if (confession) {
        const text = confession.text.substring(0, 200) + '...';
        const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=confession,anonymous`;
        window.open(twitterUrl, '_blank');
    }
}

function copyShareLink(confessionId) {
    const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
    navigator.clipboard.writeText(url).then(() => {
        alert('Link copied to clipboard!');
    }).catch(() => {
        prompt('Copy this link:', url);
    });
}

function createShareCard(confessionId) {
    const confession = getConfessionById(confessionId);
    if (!confession) return;
    
    // Update share card content
    document.getElementById('share-card-text').textContent = confession.text;
    document.getElementById('share-card-date').textContent = formatDate(new Date(confession.timestamp));
    
    const totalReactions = Object.values(confession.reactions || {}).reduce((sum, val) => sum + val, 0);
    document.getElementById('share-card-stats').innerHTML = `
        <span><i class="fas fa-heart"></i> ${totalReactions}</span>
        <span><i class="fas fa-eye"></i> ${confession.views || 0}</span>
    `;
    
    // Generate QR code
    const qrContainer = document.getElementById('share-card-qr');
    qrContainer.innerHTML = '';
    const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
    new QRCode(qrContainer, {
        text: url,
        width: 80,
        height: 80
    });
    
    // Create image preview
    setTimeout(() => {
        const shareCard = document.querySelector('#share-card-canvas .share-card');
        html2canvas(shareCard).then(canvas => {
            // Show preview in modal
            const modal = document.getElementById('share-card-modal');
            const previewContainer = document.getElementById('share-card-preview');
            previewContainer.innerHTML = '';
            
            // Create image element from canvas
            const image = new Image();
            image.src = canvas.toDataURL('image/png');
            image.style.maxWidth = '100%';
            image.style.borderRadius = '8px';
            image.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            
            previewContainer.appendChild(image);
            
            // Store the image data for potential download
            window.currentShareCardData = canvas.toDataURL('image/png');
            window.currentShareCardId = confessionId;
            
            // Show the modal
            modal.style.display = 'block';
        });
    }, 100);
}

function getConfessionById(confessionId) {
    const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    return confessions.find(c => c.id === confessionId);
}

function showLeaderboard() {
    const modal = document.getElementById('leaderboard-modal');
    const content = document.getElementById('leaderboard-content');
    
    modal.style.display = 'block';
    
    // Get all users' karma
    const users = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('userData_')) {
            const userData = JSON.parse(localStorage.getItem(key));
            users.push({
                id: key.replace('userData_', ''),
                karma: userData.karma || 0,
                achievements: userData.achievements || []
            });
        }
    }
    
    // Sort by karma
    users.sort((a, b) => b.karma - a.karma);
    
    // Display top 10
    content.innerHTML = users.slice(0, 10).map((user, index) => {
        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
        return `
            <div class="leaderboard-item">
                <span class="rank ${rankClass}">#${index + 1}</span>
                <div class="user-info">
                    <span class="user-name">Anonymous User ${user.id.substr(-4)}</span>
                    <div class="user-achievements">
                        ${user.achievements.length} achievements
                    </div>
                </div>
                <span class="karma-badge">${user.karma} karma</span>
            </div>
        `;
    }).join('');
}

function reactToConfession(confessionId, reactionType) {
    try {
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        const confessionIndex = confessions.findIndex(c => c.id === confessionId);
        
        if (confessionIndex !== -1) {
            if (!confessions[confessionIndex].reactions) {
                confessions[confessionIndex].reactions = {
                    like: 0,
                    dislike: 0,
                    love: 0,
                    haha: 0,
                    wow: 0,
                    sad: 0
                };
            }
            
            confessions[confessionIndex].reactions[reactionType]++;
            localStorage.setItem('confessions', JSON.stringify(confessions));
            
            // Add karma to the confession owner
            const confessionOwner = confessions[confessionIndex].userId;
            if (confessionOwner && confessionOwner !== userId) {
                const karmaPoints = reactionType === 'love' ? KARMA_POINTS.receiveLove : KARMA_POINTS.receiveReaction;
                addKarmaToUser(confessionOwner, karmaPoints);
            }
            
            loadConfessions();
        }
    } catch (error) {
        console.error("Error in reactToConfession:", error);
    }
}

function createPagination(totalPages) {
    const paginationContainer = document.getElementById('pagination');
    paginationContainer.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'page-btn';
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    paginationContainer.appendChild(prevBtn);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => changePage(i);
            paginationContainer.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.margin = '0 5px';
            paginationContainer.appendChild(ellipsis);
        }
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'page-btn';
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    paginationContainer.appendChild(nextBtn);
}

function changePage(page) {
    currentPage = page;
    loadConfessions();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function formatDate(date) {
    try {
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffSec < 60) {
            return 'just now';
        } else if (diffMin < 60) {
            return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
        } else if (diffHour < 24) {
            return `${diffHour} hour${diffHour === 1 ? '' : 's'} ago`;
        } else {
            return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
        }
    } catch (error) {
        console.error("Error formatting date:", error);
        return "unknown time";
    }
}

function reportConfession(confessionId) {
    try {
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        const confessionIndex = confessions.findIndex(c => c.id === confessionId);
        
        if (confessionIndex !== -1) {
            if (!confessions[confessionIndex].reports) {
                confessions[confessionIndex].reports = 0;
            }
            
            confessions[confessionIndex].reports++;
            
            // Auto-hide after 5 reports
            if (confessions[confessionIndex].reports >= 5) {
                confessions[confessionIndex].reported = true;
            }
            
            localStorage.setItem('confessions', JSON.stringify(confessions));
            loadConfessions();
            alert('Thank you for reporting. We will review this confession.');
        }
    } catch (error) {
        console.error("Error in reportConfession:", error);
    }
}

function deleteConfession(confessionId) {
    if (confirm('Are you sure you want to delete this confession?')) {
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        confessions = confessions.filter(c => c.id !== confessionId);
        localStorage.setItem('confessions', JSON.stringify(confessions));
        
        // Check if this was the confession of the day
        const cotd = localStorage.getItem('confession_of_day');
        if (cotd === confessionId) {
            setConfessionOfDay();
        }
        
        loadConfessions();
        updateStatistics();
    }
}

function showRandomConfession() {
    const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    
    if (confessions.length === 0) {
        alert('No confessions available to show.');
        return;
    }
    
    const randomIndex = Math.floor(Math.random() * confessions.length);
    const randomConfession = confessions[randomIndex];
    
    incrementViewCount(randomConfession.id);
    
    // Find the page containing this confession
    const sortedConfessions = applyFilters(confessions);
    const confessionIndex = sortedConfessions.findIndex(c => c.id === randomConfession.id);
    const page = Math.floor(confessionIndex / CONFESSIONS_PER_PAGE) + 1;
    
    if (page !== currentPage) {
        changePage(page);
    }
    
    setTimeout(() => {
        const confessionElement = document.querySelector(`[data-id="${randomConfession.id}"]`);
        if (confessionElement) {
            confessionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            confessionElement.style.backgroundColor = 'var(--primary-light)';
            setTimeout(() => {
                confessionElement.style.backgroundColor = '';
                confessionElement.style.transition = 'background-color 1s ease';
            }, 2000);
        }
    }, 300);
}

function setConfessionOfDay() {
    const now = new Date();
    const lastUpdate = localStorage.getItem('last_cotd_update');
    const lastUpdateDate = lastUpdate ? new Date(lastUpdate) : null;
    
    if (!lastUpdate || lastUpdateDate.toDateString() !== now.toDateString()) {
        const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        
        if (confessions.length > 0) {
            const randomIndex = Math.floor(Math.random() * confessions.length);
            const cotdId = confessions[randomIndex].id;
            
            localStorage.setItem('confession_of_day', cotdId);
            localStorage.setItem('last_cotd_update', now.toISOString());
        } else {
            localStorage.removeItem('confession_of_day');
        }
    }
    
    displayConfessionOfDay();
}

function displayConfessionOfDay() {
    const cotdContainer = document.getElementById('confession-of-day-container');
    const cotdId = localStorage.getItem('confession_of_day');
    
    if (!cotdId) {
        cotdContainer.innerHTML = '';
        return;
    }
    
    const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const cotd = confessions.find(c => c.id === cotdId);
    
    if (!cotd) {
        localStorage.removeItem('confession_of_day');
        setConfessionOfDay();
        return;
    }
    
    incrementViewCount(cotd.id);
    
    cotdContainer.innerHTML = `
        <div class="container">
            <h2><i class="fas fa-star"></i> Confession of the Day</h2>
            <div class="confession confession-of-day" data-id="${cotd.id}">
                ${cotd.category ? `<span class="category-badge" style="background-color: var(--primary-light); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block;">${cotd.category}</span>` : ''}
                <p>${cotd.text}</p>
                <div class="meta">
                    <div class="meta-info">
                        <div class="timestamp">
                            <i class="far fa-clock"></i> ${formatDate(new Date(cotd.timestamp))}
                        </div>
                        <div class="views">
                            <i class="far fa-eye"></i> ${cotd.views || 0} views
                        </div>
                    </div>
                    <div class="actions">
                        ${createReactionButtons(cotd)}
                        <button class="share-button" onclick="shareConfession('${cotd.id}', '${encodeURIComponent(cotd.text)}')">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
}

function updateStatistics() {
    const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const today = new Date();
    const todayConfessions = confessions.filter(c => {
        const confDate = new Date(c.timestamp);
        return confDate.toDateString() === today.toDateString();
    });
    
    document.getElementById('total-confessions').textContent = confessions.length;
    document.getElementById('today-confessions').textContent = todayConfessions.length;
    
    // Count active users based on leaderboard
    let activeUsers = 0;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('userData_')) {
            activeUsers++;
        }
    }
    document.getElementById('active-users').textContent = activeUsers;
}

function autoArchiveOldConfessions() {
    const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    let archivedConfessions = JSON.parse(localStorage.getItem('archived_confessions')) || [];
    
    const now = new Date();
    const cutoffDate = new Date(now.getTime() - (AUTO_ARCHIVE_DAYS * 24 * 60 * 60 * 1000));
    
    const newConfessions = confessions.filter(confession => {
        const confessionDate = new Date(confession.timestamp);
        if (confessionDate < cutoffDate) {
            archivedConfessions.push(confession);
            return false;
        }
        return true;
    });
    
    if (newConfessions.length !== confessions.length) {
        localStorage.setItem('confessions', JSON.stringify(newConfessions));
        localStorage.setItem('archived_confessions', JSON.stringify(archivedConfessions));
        loadConfessions();
        
        // Check if confession of the day was archived
        const cotdId = localStorage.getItem('confession_of_day');
        if (cotdId && !newConfessions.some(c => c.id === cotdId)) {
            setConfessionOfDay();
        }
    }
}

function checkSharedConfession() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedConfessionId = urlParams.get('confession');
    
    if (sharedConfessionId) {
        incrementViewCount(sharedConfessionId);
        
        const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        const sharedConfession = confessions.find(c => c.id === sharedConfessionId);
        
        if (sharedConfession) {
            setTimeout(() => {
                const confessionElement = document.querySelector(`[data-id="${sharedConfessionId}"]`);
                if (confessionElement) {
                    confessionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    confessionElement.style.backgroundColor = 'var(--primary-light)';
                    setTimeout(() => {
                        confessionElement.style.backgroundColor = '';
                        confessionElement.style.transition = 'background-color 1s ease';
                    }, 3000);
                }
            }, 500);
        }
    }
}

function incrementViewCount(confessionId) {
    try {
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        const confessionIndex = confessions.findIndex(c => c.id === confessionId);
        
        if (confessionIndex !== -1) {
            if (typeof confessions[confessionIndex].views !== 'number') {
                confessions[confessionIndex].views = 0;
            }
            
            confessions[confessionIndex].views++;
            localStorage.setItem('confessions', JSON.stringify(confessions));
            return confessions[confessionIndex].views;
        }
    } catch (error) {
        console.error("Error incrementing view count:", error);
    }
    return 0;
}

function handleSearch(e) {
    searchQuery = e.target.value;
    currentPage = 1;
    loadConfessions();
}

function handleSortChange(e) {
    currentSort = e.target.value;
    currentPage = 1;
    loadConfessions();
}

function handleCategoryFilterChange(e) {
    currentCategory = e.target.value;
    currentPage = 1;
    loadConfessions();
}

function handleAdminLogin() {
    const password = document.getElementById('admin-password').value;
    const adminPanel = document.getElementById('admin-panel');
    
    if (password === 'admin123') { // In production, use secure authentication
        adminPanel.style.display = 'block';
        document.getElementById('admin-password').value = '';
        document.body.classList.add('admin-mode');
        sessionStorage.setItem('isAdmin', 'true');
    } else {
        alert('Incorrect password');
    }
}

function clearAllConfessions() {
    if (confirm('Are you sure you want to clear all confessions? This action cannot be undone.')) {
        localStorage.removeItem('confessions');
        localStorage.removeItem('archived_confessions');
        localStorage.removeItem('confession_of_day');
        localStorage.removeItem('last_cotd_update');
        loadConfessions();
        setConfessionOfDay();
        updateStatistics();
    }
}
</script>
</body>
</html>
