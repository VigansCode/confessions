<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonymous Confessions | Share Your Secrets</title>
<meta name="description" content="Share your anonymous confessions and secrets with the world. A safe space to express yourself freely.">
<meta property="og:title" content="Anonymous Confessions">
<meta property="og:description" content="Share your anonymous confessions and secrets with the world.">
<meta property="og:type" content="website">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, limit, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyADTUf0vuhZXm2rnNLoXC9fjxAtMtiTSnA",
    authDomain: "confessions-121bc.firebaseapp.com",
    projectId: "confessions-121bc",
    storageBucket: "confessions-121bc.firebasestorage.app",
    messagingSenderId: "339849633893",
    appId: "1:339849633893:web:a5a739b760e9a3ec77e68c",
    measurementId: "G-8755436E5W"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // Make Firebase services available globally
  window.firebaseServices = {
    db,
    collection,
    addDoc,
    getDocs,
    doc,
    updateDoc,
    deleteDoc,
    query,
    orderBy,
    limit,
    where,
    serverTimestamp
  };
</script>

<style>
:root {
    --primary-color: #6c5ce7;
    --primary-light: #a29bfe;
    --primary-dark: #4834d4;
    --accent-color: #fd79a8;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --danger-color: #d63031;
    --text-color: #2d3436;
    --text-light: #636e72;
    --bg-color: #f8f9fa;
    --card-color: #ffffff;
    --border-color: #eee;
    --karma-bronze: #cd7f32;
    --karma-silver: #c0c0c0;
    --karma-gold: #ffd700;
    --crypto-color: #f7931a;
}

[data-theme="dark"] {
    --primary-color: #6c5ce7;
    --primary-light: #a29bfe;
    --primary-dark: #4834d4;
    --accent-color: #fd79a8;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --danger-color: #d63031;
    --text-color: #f5f6fa;
    --text-light: #dcdde1;
    --bg-color: #1e272e;
    --card-color: #2d3436;
    --border-color: #353b48;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Navigation Bar */
.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border-color);
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-container i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.logo-text {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.nav-links {
    display: flex;
    align-items: center;
    gap: 20px;
}

.nav-link {
    color: var(--text-color);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
}

.nav-link:hover {
    color: var(--primary-color);
}

/* Donation Button in Nav */
.donate-nav-btn {
    background: linear-gradient(135deg, var(--crypto-color), #e6951e);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.donate-nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(247, 147, 26, 0.3);
}

/* Karma Display */
.karma-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--card-color);
    padding: 5px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    font-size: 0.9rem;
}

.karma-display i {
    color: var(--karma-gold);
}

/* Funding Goals Section */
.funding-goals {
    margin-bottom: 30px;
}

.goal-card {
    background: var(--card-color);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    margin-bottom: 15px;
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.goal-title {
    font-weight: 600;
    color: var(--text-color);
    font-size: 1.1rem;
}

.goal-status {
    font-size: 0.9rem;
    color: var(--text-light);
}

.goal-progress-bar {
    height: 12px;
    background: var(--border-color);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
}

.goal-progress-fill {
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 5px;
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
}

.goal-info {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.9rem;
}

.goal-raised {
    color: var(--primary-color);
    font-weight: 600;
}

.goal-target {
    color: var(--text-light);
}

/* Wallet Section Styles */
.wallet-section {
    margin-top: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(108, 92, 231, 0.05);
    border-radius: 8px;
}

.wallet-section label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--text-color);
}

.wallet-info-tooltip {
    cursor: help;
    color: var(--text-light);
}

.wallet-select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--card-color);
    color: var(--text-color);
    font-family: inherit;
}

.wallet-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 5px;
    background: var(--card-color);
    color: var(--text-color);
    font-family: monospace;
}

.wallet-disclaimer {
    color: var(--text-light);
    font-size: 0.85rem;
    display: block;
    margin-top: 5px;
}

/* Tip Button */
.tip-button {
    background: linear-gradient(135deg, var(--crypto-color), #e6951e);
    color: white;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    padding: 5px 10px;
    margin: 0;
    box-shadow: none;
    border-radius: 8px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 32px;
    gap: 5px;
}

.tip-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(247, 147, 26, 0.3);
}

/* Donation Modal */
.donation-modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    animation: fadeIn 0.3s ease;
}

.donation-modal-content {
    background-color: var(--card-color);
    margin: 5% auto;
    padding: 30px;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    position: relative;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.donation-header {
    text-align: center;
    margin-bottom: 25px;
}

.donation-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.donation-subtitle {
    color: var(--text-light);
    font-size: 0.95rem;
}

.donation-amounts {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.amount-btn {
    background: var(--card-color);
    border: 2px solid var(--border-color);
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    font-weight: 600;
    color: var(--text-color);
}

.amount-btn:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.amount-btn.selected {
    border-color: var(--primary-color);
    background: rgba(108, 92, 231, 0.1);
    color: var(--primary-color);
}

.custom-amount-container {
    margin-bottom: 20px;
}

.custom-amount-input {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 1rem;
    text-align: center;
    background: var(--card-color);
    color: var(--text-color);
}

.custom-amount-input:focus {
    border-color: var(--primary-color);
    outline: none;
}

.payment-options {
    margin-bottom: 20px;
}

.payment-method {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method:hover {
    border-color: var(--primary-color);
}

.payment-method.selected {
    border-color: var(--primary-color);
    background: rgba(108, 92, 231, 0.1);
}

.payment-method i {
    font-size: 1.5rem;
    margin-right: 15px;
    color: var(--crypto-color);
}

.payment-info {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    color: var(--text-color);
}

.payment-desc {
    font-size: 0.85rem;
    color: var(--text-light);
}

.donation-address {
    display: none;
    background: var(--bg-color);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    word-break: break-all;
    font-family: monospace;
    font-size: 0.9rem;
    text-align: center;
}

.copy-address-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 10px;
    font-weight: 600;
}

.charity-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.charity-checkbox {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.charity-checkbox input {
    margin-right: 10px;
}

.charity-dropdown {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    background: var(--card-color);
    color: var(--text-color);
    display: none;
}

.donate-submit-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.donate-submit-btn:hover {
    transform: translateY(-2px);
}

.donate-submit-btn:disabled {
    background: var(--text-light);
    cursor: not-allowed;
    transform: none;
}

/* Donor Recognition */
.donor-badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, var(--crypto-color), #e6951e);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: 8px;
}

.donor-badge i {
    margin-right: 4px;
    font-size: 0.8rem;
}

/* Thank You Modal */
.thank-you-modal {
    text-align: center;
}

.thank-you-icon {
    font-size: 3rem;
    color: var(--success-color);
    margin-bottom: 15px;
}

/* Leaderboard Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--card-color);
    margin: 5% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.close {
    color: var(--text-light);
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--text-color);
}

/* Leaderboard */
.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    gap: 15px;
}

.rank {
    font-weight: bold;
    font-size: 1.2rem;
    width: 30px;
    text-align: center;
}

.rank.gold { color: var(--karma-gold); }
.rank.silver { color: var(--karma-silver); }
.rank.bronze { color: var(--karma-bronze); }

.karma-badge {
    background: var(--primary-light);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-left: auto;
}

/* Share Card Styles */
.share-card {
    background: var(--card-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
    min-height: 200px;
}

.share-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.share-card-logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: var(--primary-color);
}

.share-card-content {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 20px;
}

.share-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
}

.qr-code {
    width: 80px;
    height: 80px;
}

/* Reply System Styles */
.replies-section {
    margin-top: 20px;
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
}

.replies-toggle {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 0.9rem;
    padding: 5px 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.replies-toggle:hover {
    text-decoration: underline;
}

.replies-container {
    margin-top: 15px;
    display: none;
}

.replies-container.active {
    display: block;
}

.reply {
    background: rgba(var(--primary-color), 0.05);
    border-left: 3px solid var(--primary-light);
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 0 8px 8px 0;
}

.reply-form {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.reply-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    resize: none;
    background: var(--card-color);
    color: var(--text-color);
}

.reply-submit {
    padding: 8px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}

.reply-submit:hover {
    background: var(--primary-dark);
}

.reply-count {
    color: var(--text-light);
    font-size: 0.8rem;
    margin-left: 5px;
}

/* Notification Badge */
.notification-badge {
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.7rem;
    position: absolute;
    top: -5px;
    right: -5px;
}

/* Share Options */
.share-options {
    display: none;
    position: absolute;
    background: var(--card-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    right: 0;
    top: 100%;
    margin-top: 5px;
    min-width: 150px;
}

.share-options.active {
    display: block;
}

.share-option-btn {
    display: block;
    width: 100%;
    text-align: left;
    padding: 8px 12px;
    border: none;
    background: none;
    cursor: pointer;
    color: var(--text-color);
    font-size: 0.9rem;
}

.share-option-btn:hover {
    background: var(--bg-color);
}

.share-option-btn i {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

/* Achievement Popup */
.achievement-popup {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success-color);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none;
    animation: slideIn 0.3s ease-out;
    z-index: 1000;
}

.achievement-popup.show {
    display: block;
}

.achievement-popup h4 {
    margin: 0 0 5px 0;
    font-size: 1rem;
}

.achievement-popup p {
    margin: 0;
    font-size: 0.85rem;
    opacity: 0.9;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Stats Dashboard Update */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--card-color);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    position: relative;
    transition: transform 0.3s ease;
}

.stat-card.clickable {
    cursor: pointer;
}

.stat-card.clickable:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    color: var(--text-light);
    font-size: 0.9rem;
}

h1 {
    text-align: center;
    color: var(--primary-color);
    margin: 30px 0;
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
}

h2 {
    color: var(--primary-dark);
    font-size: 1.5rem;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--primary-light);
    padding-bottom: 8px;
    display: flex;
    align-items: center;
}

h2 i {
    margin-right: 10px;
    color: var(--primary-color);
}

.container {
    background-color: var(--card-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    margin-bottom: 30px;
    transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
}

.container:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.1);
}

.rules-banner {
    background-color: #f1f2f6;
    border-left: 4px solid var(--warning-color);
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
}

[data-theme="dark"] .rules-banner {
    background-color: rgba(45, 52, 54, 0.7);
}

.rules-banner h3 {
    margin: 0 0 10px 0;
    color: var(--warning-color);
}

.rules-banner ul {
    margin: 0;
    padding-left: 20px;
}

textarea {
    width: 100%;
    height: 120px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    resize: vertical;
    font-family: inherit;
    margin-bottom: 5px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    transition: border 0.3s ease, box-shadow 0.3s ease;
    font-size: 1rem;
    background-color: var(--card-color);
    color: var(--text-color);
}

textarea:focus {
    border-color: var(--primary-color);
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(108, 92, 231, 0.3);
    outline: none;
}

.textarea-container {
    position: relative;
    margin-bottom: 15px;
}

.character-count {
    position: absolute;
    right: 10px;
    bottom: 5px;
    font-size: 0.8rem;
    color: var(--text-light);
    background-color: rgba(255, 255, 255, 0.8);
    padding: 2px 8px;
    border-radius: 4px;
}

.character-count.warning {
    color: var(--danger-color);
}

[data-theme="dark"] .character-count {
    background-color: rgba(0, 0, 0, 0.5);
}

button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

button i {
    margin-right: 8px;
}

button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.15);
}

button:disabled {
    background-color: var(--text-light);
    cursor: not-allowed;
    transform: none;
}

.button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

#random-confession {
    background-color: var(--primary-light);
}

#random-confession:hover {
    background-color: var(--primary-color);
}
#theme-toggle {
    background-color: #2c3e50;
    position: fixed;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

#theme-toggle i {
    margin: 0;
}

/* Categories */
.category-selector {
    margin-bottom: 20px;
}

.category-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.category-tag {
    padding: 5px 15px;
    border-radius: 20px;
    background-color: var(--primary-light);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.category-tag:hover {
    background-color: var(--primary-color);
}

.category-tag.active {
    background-color: var(--primary-dark);
}

/* Filter Options */
.filter-options {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
}

.filter-select {
    padding: 8px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-color);
    color: var(--text-color);
    font-family: inherit;
}

/* Search Bar */
.search-container {
    position: relative;
    margin-bottom: 20px;
}

.search-input {
    width: 100%;
    padding: 10px 40px 10px 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    background-color: var(--card-color);
    color: var(--text-color);
}

.search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
   transform: translateY(-50%);
   color: var(--text-light);
}

/* Confession Cards */
.confessions-list {
   display: grid;
   grid-gap: 20px;
}

.confession {
   background-color: var(--card-color);
   padding: 20px;
   border-radius: 10px;
   position: relative;
   box-shadow: 0 4px 12px rgba(0,0,0,0.06);
   border-left: 4px solid var(--primary-color);
   transition: transform 0.3s ease, box-shadow 0.3s ease;
   animation: fadeIn 0.5s ease-out;
}

.confession:hover {
   transform: translateY(-3px);
   box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

.confession.reported {
   opacity: 0.6;
   border-left-color: var(--danger-color);
}

.confession p {
   margin: 0;
   line-height: 1.6;
   font-size: 1.05rem;
}

.confession .meta {
   display: flex;
   justify-content: space-between;
   align-items: center;
   margin-top: 15px;
   padding-top: 10px;
   border-top: 1px solid var(--border-color);
   flex-wrap: wrap;
   gap: 10px;
}

.confession .timestamp,
.confession .views {
   font-size: 0.8rem;
   color: var(--text-light);
   display: flex;
   align-items: center;
   margin: 0;
}

.timestamp i,
.views i {
   margin-right: 5px;
   font-size: 0.8rem;
}

.meta-info {
   display: flex;
   align-items: center;
   gap: 15px;
   flex-wrap: wrap;
}

.confession .actions {
   display: flex;
   gap: 10px;
   align-items: center;
}

.confession-of-day {
   border: 2px solid #fbc531;
   border-left-width: 6px;
   position: relative;
}

.confession-of-day::before {
   content: "Confession of the Day";
   position: absolute;
   top: -10px;
   left: 10px;
   background-color: #fbc531;
   color: #2d3436;
   padding: 2px 10px;
   border-radius: 4px;
   font-size: 0.8rem;
   font-weight: bold;
}

.react-button {
   background: none;
   border: none;
   font-size: 1.1rem;
   cursor: pointer;
   padding: 0 8px;
   margin: 0;
   box-shadow: none;
   color: var(--text-light);
   transition: transform 0.2s ease, color 0.2s ease;
   display: inline-flex;
   align-items: center;
   gap: 4px;
   height: 32px;
   min-width: 45px;
   justify-content: center;
}

.react-button:hover {
   transform: scale(1.2);
   background: none;
   box-shadow: none;
   color: var(--primary-color);
}

.react-button.active {
   color: var(--primary-color);
}

/* Color-coded reactions */
.react-button.like i { color: #3b5998; }
.react-button.dislike i { color: #8b0000; }
.react-button.love i { color: #e25b5b; }
.react-button.haha i { color: #f7b928; }
.react-button.wow i { color: #54c7ec; }
.react-button.sad i { color: #8a8d91; }

.reaction-count {
   font-size: 0.85rem;
   margin-left: 2px;
   font-weight: 600;
   color: var(--text-light);
   min-width: 16px;
   text-align: left;
}

.share-button,
.report-button {
   background: none;
   border: none;
   font-size: 1rem;
   cursor: pointer;
   padding: 5px;
   margin: 0;
   box-shadow: none;
   color: var(--text-light);
   transition: transform 0.2s ease, color 0.2s ease;
   position: relative;
   display: inline-flex;
   align-items: center;
   justify-content: center;
   height: 32px;
   min-width: 32px;
}

.share-button:hover {
   background: none;
   box-shadow: none;
   color: var(--primary-color);
}

.report-button:hover {
   background: none;
   box-shadow: none;
   color: var(--danger-color);
}

.admin-action {
   display: none;
   position: absolute;
   top: 10px;
   right: 10px;
   background-color: #e74c3c;
   color: white;
   border: none;
   width: 30px;
   height: 30px;
   border-radius: 50%;
   cursor: pointer;
   font-size: 0.8rem;
   transition: background-color 0.3s ease;
   align-items: center;
   justify-content: center;
}

.admin-mode .admin-action {
   display: flex;
}

.admin-action:hover {
   background-color: #c0392b;
}

.no-confessions {
   text-align: center;
   color: var(--text-light);
   padding: 30px 20px;
   font-style: italic;
   background-color: rgba(255,255,255,0.7);
   border-radius: 10px;
   border: 1px dashed var(--border-color);
}

[data-theme="dark"] .no-confessions {
   background-color: rgba(0,0,0,0.2);
}

.no-confessions i {
   display: block;
   font-size: 2rem;
   margin-bottom: 10px;
   color: var(--primary-light);
}

/* Pagination */
.pagination {
   display: flex;
   justify-content: center;
   align-items: center;
   gap: 10px;
   margin-top: 30px;
}

.page-btn {
   padding: 8px 15px;
   border: 1px solid var(--border-color);
   background: var(--card-color);
   color: var(--text-color);
   border-radius: 8px;
   cursor: pointer;
   transition: all 0.3s ease;
}

.page-btn:hover {
   background: var(--primary-light);
   color: white;
   border-color: var(--primary-light);
}

.page-btn.active {
   background: var(--primary-color);
   color: white;
   border-color: var(--primary-color);
}

.page-btn:disabled {
   background: var(--border-color);
   cursor: not-allowed;
   opacity: 0.5;
}

/* Loading States */
.loading {
   display: flex;
   justify-content: center;
   align-items: center;
   padding: 40px;
   color: var(--primary-color);
}

.loading i {
   font-size: 2rem;
   animation: spin 1s linear infinite;
}

/* Success Message */
.success-message {
   background-color: var(--success-color);
   color: white;
   padding: 15px;
   border-radius: 8px;
   margin-bottom: 20px;
   display: none;
   align-items: center;
   animation: slideDown 0.3s ease-out;
}

.success-message i {
   margin-right: 10px;
}

/* Error Message */
.error-message {
   background-color: var(--danger-color);
   color: white;
   padding: 15px;
   border-radius: 8px;
   margin-bottom: 20px;
   display: none;
   align-items: center;
   animation: slideDown 0.3s ease-out;
}

.error-message i {
   margin-right: 10px;
}

/* Footer */
footer {
   margin-top: 50px;
   padding-top: 20px;
   border-top: 1px solid var(--border-color);
   text-align: center;
   color: var(--text-light);
}

footer a {
   color: var(--primary-color);
   text-decoration: none;
}

footer a:hover {
   text-decoration: underline;
}

/* Admin Panel */
#admin-access {
   margin-top: 20px;
   border-top: 1px solid var(--border-color);
   padding-top: 20px;
   display: none;
}

summary {
   cursor: pointer;
   color: var(--text-light);
   font-weight: 500;
   transition: color 0.3s ease;
   display: flex;
   align-items: center;
}

summary:hover {
   color: var(--primary-color);
}

summary i {
   margin-right: 8px;
}

details {
   margin-top: 10px;
}

input[type="password"] {
   padding: 10px 15px;
   border: 1px solid var(--border-color);
   border-radius: 8px;
   margin-right: 10px;
   font-family: inherit;
   font-size: 0.9rem;
   box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
   background-color: var(--card-color);
   color: var(--text-color);
}

input[type="password"]:focus {
   border-color: var(--primary-color);
   outline: none;
   box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(108, 92, 231, 0.3);
}

#admin-login {
   background-color: #34495e;
}

#admin-login:hover {
   background-color: #2c3e50;
}

#clear-all {
   background-color: #e74c3c;
   margin-top: 10px;
}

#clear-all:hover {
   background-color: #c0392b;
}

/* Animations */
@keyframes fadeIn {
   from { opacity: 0; transform: translateY(10px); }
   to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
   0% { transform: scale(1); }
   50% { transform: scale(1.05); }
   100% { transform: scale(1); }
}

@keyframes spin {
   0% { transform: rotate(0deg); }
   100% { transform: rotate(360deg); }
}

@keyframes slideDown {
   from { transform: translateY(-20px); opacity: 0; }
   to { transform: translateY(0); opacity: 1; }
}

/* Firebase Connection Status */
.connection-status {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    animation: fadeIn 0.5s ease-out;
}

.status-online {
    background-color: var(--success-color);
    color: white;
}

.status-offline {
    background-color: var(--danger-color);
    color: white;
}

.status-connecting {
    background-color: var(--warning-color);
    color: #333;
}

/* Firebase Admin Settings */
.firebase-settings {
    margin-top: 20px;
    padding: 15px;
    background: rgba(108, 92, 231, 0.05);
    border-radius: 8px;
    display: none;
}

.firebase-settings h3 {
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.firebase-settings h3 i {
    color: var(--primary-color);
}

.firebase-settings .setting-group {
    margin-bottom: 15px;
}

.firebase-settings label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.firebase-settings input,
.firebase-settings select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
}

.global-badge {
    background-color: var(--success-color);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    margin-left: 8px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.global-badge i {
    font-size: 0.8rem;
}

/* Responsive Design */
@media (max-width: 600px) {
   body {
       padding: 10px;
   }
   
   .button-group {
       flex-direction: column;
   }
   
   #theme-toggle {
       top: 10px;
       right: 10px;
   }
   
   .category-tags {
       justify-content: center;
   }
   
   .filter-options {
       flex-direction: column;
       align-items: stretch;
   }
   
   .navbar {
       flex-direction: column;
       gap: 10px;
   }
   
   .nav-links {
       flex-wrap: wrap;
       justify-content: center;
   }
   
   .confession .meta {
       flex-direction: column;
       align-items: flex-start;
   }
   
   .confession .actions {
       width: 100%;
       justify-content: space-between;
       margin-top: 10px;
   }
   
   .react-button {
       min-width: auto;
       padding: 0 5px;
   }
   
   .donation-amounts {
       grid-template-columns: repeat(2, 1fr);
   }
   
   .donor-badge {
       display: none;
   }
}
</style>
</head>
<body>
<button id="theme-toggle" aria-label="Toggle dark mode">
<i class="fas fa-moon"></i>
</button>

<div id="connection-status" class="connection-status status-connecting">
    <i class="fas fa-circle-notch fa-spin"></i>
    <span>Connecting...</span>
</div>

<nav class="navbar">
<div class="logo-container">
   <i class="fas fa-feather-alt"></i>
   <span class="logo-text">Confessions</span>
</div>
<div class="nav-links">
   <a href="#" class="nav-link" id="home-link">Home</a>
   <a href="#" class="nav-link" id="about-link">About</a>
   <a href="#" class="nav-link" id="rules-link">Rules</a>
   <a href="#" class="nav-link" id="global-link">Global</a>
   <button class="donate-nav-btn" id="donate-nav-btn">
       <i class="fas fa-hand-holding-usd"></i> Support
   </button>
   <div class="karma-display" id="karma-display" style="cursor: pointer;">
       <i class="fas fa-star"></i>
       <span id="user-karma">0</span> Karma
   </div>
</div>
</nav>

<h1>Anonymous Confessions</h1>

<!-- Funding Goals Section -->
<div class="funding-goals" id="funding-goals">
   <h2><i class="fas fa-chart-pie"></i> Community Goals</h2>
   <div class="goal-card">
       <div class="goal-header">
           <span class="goal-title">Server Maintenance</span>
           <span class="goal-status">Monthly</span>
       </div>
       <div class="goal-progress-bar">
           <div class="goal-progress-fill" id="server-goal-progress" style="width: 0%;">0%</div>
       </div>
       <div class="goal-info">
           <span class="goal-raised" id="server-goal-raised">$0 raised</span>
           <span class="goal-target">of $500 goal</span>
       </div>
   </div>
   
   <div class="goal-card">
       <div class="goal-header">
           <span class="goal-title">Feature Development Fund</span>
           <span class="goal-status">This Quarter</span>
       </div>
       <div class="goal-progress-bar">
           <div class="goal-progress-fill" id="feature-goal-progress" style="width: 0%;">0%</div>
       </div>
       <div class="goal-info">
           <span class="goal-raised" id="feature-goal-raised">$0 raised</span>
           <span class="goal-target">of $2,000 goal</span>
       </div>
   </div>
   
   <div class="goal-card">
       <div class="goal-header">
           <span class="goal-title">Charity: Mental Health Support</span>
           <span class="goal-status">This Year</span>
       </div>
       <div class="goal-progress-bar">
           <div class="goal-progress-fill" id="charity-goal-progress" style="width: 0%;">0%</div>
       </div>
       <div class="goal-info">
           <span class="goal-raised" id="charity-goal-raised">$0 raised</span>
           <span class="goal-target">of $10,000 goal</span>
       </div>
   </div>
</div>

<div class="stats-container">
<div class="stat-card">
   <div class="stat-number" id="total-confessions">0</div>
   <div class="stat-label">Total Confessions</div>
</div>
<div class="stat-card">
   <div class="stat-number" id="today-confessions">0</div>
   <div class="stat-label">Today's Confessions</div>
</div>
<div class="stat-card clickable" id="leaderboard-card">
   <div class="stat-number" id="active-users">0</div>
   <div class="stat-label">Top Contributors</div>
</div>
</div>

<div id="confession-of-day-container"></div>

<div class="container confession-form">
<h2><i class="fas fa-comment-dots"></i> Share Your Confession</h2>

<div class="rules-banner">
   <h3><i class="fas fa-exclamation-triangle"></i> Community Guidelines</h3>
   <ul>
       <li>Be respectful - no hate speech or harassment</li>
       <li>Keep it legal - no criminal confessions</li>
       <li>Your confession is anonymous and safe</li>
   </ul>
</div>

<div class="success-message" id="success-message">
   <i class="fas fa-check-circle"></i>
   Your confession has been submitted successfully!
</div>

<div class="error-message" id="error-message">
   <i class="fas fa-exclamation-circle"></i>
   <span id="error-text">An error occurred. Please try again.</span>
</div>

<form id="confession-form">
   <div class="category-selector">
       <label for="category">Category (optional):</label>
       <div class="category-tags">
           <span class="category-tag active" data-category="all">All</span>
           <span class="category-tag" data-category="funny">Funny</span>
           <span class="category-tag" data-category="serious">Serious</span>
           <span class="category-tag" data-category="relationships">Relationships</span>
           <span class="category-tag" data-category="work">Work</span>
           <span class="category-tag" data-category="family">Family</span>
           <span class="category-tag" data-category="secret">Secret</span>
       </div>
   </div>
   
   <div class="textarea-container">
       <textarea id="confession-text" placeholder="Type your confession here... (anonymous)" required maxlength="1000"></textarea>
       <div class="character-count">0/1000 characters</div>
   </div>
   
   <!-- Wallet address section -->
   <div class="wallet-section">
       <label for="wallet-address">
           <i class="fas fa-wallet"></i> Receive Tips (optional)
           <span class="wallet-info-tooltip" title="Add your crypto wallet address to receive tips directly from readers">
               <i class="fas fa-info-circle"></i>
           </span>
       </label>
       <select id="wallet-type" class="wallet-select">
           <option value="">Select wallet type</option>
           <option value="bitcoin">Bitcoin (BTC)</option>
           <option value="ethereum">Ethereum (ETH)</option>
           <option value="lightning">Lightning Network</option>
       </select>
       <input type="text" id="wallet-address" class="wallet-input" placeholder="Enter your wallet address" style="display: none;">
       <small class="wallet-disclaimer">Your wallet address will be visible to allow direct tipping</small>
   </div>
   
   <div style="display: flex; align-items: center; margin-bottom: 20px;">
       <input type="checkbox" id="share-globally" style="margin-right: 10px;">
       <label for="share-globally">Share globally (using Firebase)</label>
   </div>
   
   <button type="submit" id="submit-btn"><i class="fas fa-paper-plane"></i> Submit Confession</button>
</form>
<div class="button-group">
   <button id="random-confession"><i class="fas fa-random"></i> Random Confession</button>
</div>
<div id="admin-access">
   <details>
       <summary><i class="fas fa-lock"></i> Admin Access</summary>
       <div style="margin-top: 15px;">
           <input type="password" id="admin-password" placeholder="Enter admin password">
           <button id="admin-login"><i class="fas fa-sign-in-alt"></i> Login</button>
           <div id="admin-panel" style="margin-top: 10px; display: none;">
               <button id="clear-all"><i class="fas fa-trash-alt"></i> Clear All Confessions</button>
               <button id="sync-firebase"><i class="fas fa-cloud-upload-alt"></i> Sync to Firebase</button>
               <div class="firebase-settings" id="firebase-settings">
                   <h3><i class="fas fa-sliders-h"></i> Firebase Settings</h3>
                   <div class="setting-group">
                       <label for="firebase-collection">Collection Name:</label>
                       <input type="text" id="firebase-collection" value="confessions">
                   </div>
                   <div class="setting-group">
                       <label for="firebase-limit">Fetch Limit:</label>
                       <input type="number" id="firebase-limit" value="100">
                   </div>
                   <div class="setting-group">
                       <button id="save-firebase-settings"><i class="fas fa-save"></i> Save Settings</button>
                   </div>
               </div>
           </div>
       </div>
   </details>
</div>
</div>
<div class="container">
<h2><i class="fas fa-book-open"></i> Recent Confessions</h2>

<div class="search-container">
   <input type="text" class="search-input" id="search-input" placeholder="Search confessions...">
   <i class="fas fa-search search-icon"></i>
</div>

<div class="filter-options">
   <select class="filter-select" id="sort-select">
       <option value="newest">Newest First</option>
       <option value="oldest">Oldest First</option>
       <option value="popular">Most Popular</option>
   </select>
   <select class="filter-select" id="category-filter">
       <option value="all">All Categories</option>
       <option value="funny">Funny</option>
       <option value="serious">Serious</option>
       <option value="relationships">Relationships</option>
       <option value="work">Work</option>
       <option value="family">Family</option>
       <option value="secret">Secret</option>
   </select>
</div>

<div id="confessions-list" class="confessions-list">
   <div class="loading">
       <i class="fas fa-spinner"></i>
   </div>
</div>

<div class="pagination" id="pagination"></div>
</div>

<footer>
<p>&copy; 2024 Anonymous Confessions. All rights reserved.</p>
<p><a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a> | <a href="#">Contact Us</a></p>
</footer>

<!-- Donation Modal -->
<div id="donation-modal" class="donation-modal">
   <div class="donation-modal-content">
       <span class="close" onclick="closeDonationModal()">&times;</span>
       <div class="donation-header">
           <h2 class="donation-title">Support Our Community</h2>
           <p class="donation-subtitle">Your support helps maintain this safe space for anonymous confessions</p>
       </div>
       
       <div class="donation-amounts">
           <button class="amount-btn" data-amount="5">$5</button>
           <button class="amount-btn" data-amount="10">$10</button>
           <button class="amount-btn" data-amount="25">$25</button>
           <button class="amount-btn" data-amount="50">$50</button>
           <button class="amount-btn" data-amount="100">$100</button>
           <button class="amount-btn" data-amount="custom">Custom</button>
       </div>
       
       <div class="custom-amount-container" id="custom-amount-container" style="display: none;">
           <input type="number" class="custom-amount-input" id="custom-amount-input" placeholder="Enter amount in USD" min="1">
       </div>
       
       <div class="payment-options">
           <div class="payment-method" data-method="bitcoin">
               <i class="fab fa-bitcoin"></i>
               <div class="payment-info">
                   <div class="payment-name">Bitcoin</div>
                   <div class="payment-desc">BTC payments</div>
               </div>
           </div>
           <div class="payment-method" data-method="ethereum">
               <i class="fab fa-ethereum"></i>
               <div class="payment-info">
                   <div class="payment-name">Ethereum</div>
                   <div class="payment-desc">ETH payments</div>
               </div>
           </div>
           <div class="payment-method" data-method="lightning">
               <i class="fas fa-bolt"></i>
               <div class="payment-info">
                   <div class="payment-name">Lightning Network</div>
                   <div class="payment-desc">Fast BTC payments</div>
               </div>
           </div>
       </div>
       
       <div class="donation-address" id="donation-address"></div>
       
       <div class="charity-section">
           <label class="charity-checkbox">
               <input type="checkbox" id="charity-donation">
               Donate 10% to charity
           </label>
           <select class="charity-dropdown" id="charity-select">
               <option value="">Select charity</option>
               <option value="mental-health">Mental Health Foundation</option>
               <option value="privacy-rights">Electronic Frontier Foundation</option>
               <option value="free-speech">Freedom of Press Foundation</option>
           </select>
       </div>
       
       <button class="donate-submit-btn" id="donate-submit-btn" disabled>
           Proceed to Payment
       </button>
   </div>
</div>

<!-- Modals -->
<div id="leaderboard-modal" class="modal">
<div class="modal-content">
   <span class="close">&times;</span>
   <h2><i class="fas fa-trophy"></i> Top Contributors</h2>
   <div id="leaderboard-content">
       <div class="loading">
           <i class="fas fa-spinner"></i>
       </div>
   </div>
</div>
</div>

<div id="share-card-modal" class="modal">
<div class="modal-content">
   <span class="close" onclick="closeShareCardModal()">&times;</span>
   <h2><i class="fas fa-image"></i> Share Card Preview</h2>
   <div id="share-card-preview"></div>
   <div style="text-align: center; margin-top: 20px;">
       <button onclick="downloadShareCard()" style="background-color: var(--success-color); margin-right: 10px;">
           <i class="fas fa-download"></i> Download Card
       </button>
       <button onclick="closeShareCardModal()" style="background-color: var(--text-light);">
           <i class="fas fa-times"></i> Cancel
       </button>
   </div>
</div>
</div>

<div id="achievement-popup" class="achievement-popup">
<h4 id="achievement-title"></h4>
<p id="achievement-description"></p>
</div>

<!-- Share Card Canvas (hidden) -->
<div id="share-card-canvas" style="position: absolute; left: -9999px; top: -9999px;">
<div class="share-card" style="width: 600px; background: white;">
   <div class="share-card-header">
       <div class="share-card-logo">
           <i class="fas fa-feather-alt"></i>
           <span>Anonymous Confessions</span>
       </div>
       <div id="share-card-date"></div>
   </div>
   <div class="share-card-content" id="share-card-text"></div>
   <div class="share-card-footer">
       <div id="share-card-stats"></div>
       <div id="share-card-qr" class="qr-code"></div>
   </div>
</div>
</div>

<script>
// Add this debugging code
function debugFirebase() {
    console.log("DEBUG - Firebase Services Available:", !!window.firebaseServices);
    console.log("DEBUG - Current Mode:", isGlobalMode ? "GLOBAL" : "LOCAL");
    
    if (window.firebaseServices) {
        const { db, collection, getDocs } = window.firebaseServices;
        const confessionsRef = collection(db, "confessions");
        
        getDocs(confessionsRef)
            .then((snapshot) => {
                console.log("DEBUG - Firebase Data Retrieved:", snapshot.size, "documents");
                snapshot.forEach(doc => console.log("Document ID:", doc.id));
            })
            .catch(error => console.error("DEBUG - Firebase Error:", error));
    }
}

// Run the debugging function
debugFirebase();

// Force global mode and reload confessions
function forceGlobalMode() {
    isGlobalMode = true;
    localStorage.setItem('globalMode', 'true');
    
    if (window.loadGlobalConfessions) {
        loadGlobalConfessions();
    } else {
        console.error("loadGlobalConfessions function not found");
    }
    
    console.log("Global mode forced ON");
}

// Add a button to force global mode
const debugButton = document.createElement('button');
debugButton.innerHTML = "DEBUG: Force Global Mode";
debugButton.style.position = "fixed";
debugButton.style.bottom = "10px";
debugButton.style.left = "10px";
debugButton.style.zIndex = "9999";
debugButton.onclick = forceGlobalMode;
document.body.appendChild(debugButton);

// Configuration
const CONFESSIONS_PER_PAGE = 10;
const MAX_CONFESSION_LENGTH = 1000;
const AUTO_ARCHIVE_DAYS = 30;
const FORBIDDEN_WORDS = ['hate', 'kill', 'racist', 'sexist'];

// Firebase Configuration
const FIREBASE_SETTINGS = {
    collection: 'confessions',
    userCollection: 'users',
    donationCollection: 'donations',
    fundingCollection: 'funding',
    limit: 100
};

// Donation Configuration
const DONATION_ADDRESSES = {
   bitcoin: '1YourBitcoinAddressHere',
   ethereum: '0xYourEthereumAddressHere',
   lightning: 'lightning:YourLightningAddressHere'
};

const FUNDING_GOALS = {
   server: { target: 500, current: 0 },
   feature: { target: 2000, current: 0 },
   charity: { target: 10000, current: 0 }
};

// Karma & Achievement System Configuration
const KARMA_POINTS = {
   submitConfession: 10,
   receiveReaction: 1,
   receiveReply: 2,
   receiveLove: 3,
   dailyConfession: 5,
   popularConfession: 20,  // 50+ reactions
   donateSmall: 50,      // $1-10
   donateMedium: 100,    // $11-50
   donateLarge: 250,     // $51+
   donateCharity: 500,   // Any charity donation
   globalContribution: 50 // Sharing globally
};

const ACHIEVEMENTS = {
   firstConfession: {
       id: 'first_confession',
       title: 'First Steps',
       description: 'Submit your first confession',
       karma: 50
   },
   popularConfession: {
       id: 'popular_confession',
       title: 'Crowd Favorite',
       description: 'Get 50+ reactions on a confession',
       karma: 100
   },
   dailyStreak: {
       id: 'daily_streak',
       title: 'Regular Contributor',
       description: 'Submit confessions 7 days in a row',
       karma: 200
   },
   conversationStarter: {
       id: 'conversation_starter',
       title: 'Conversation Starter',
       description: 'Get 10+ replies on a confession',
       karma: 150
   },
   karmaLegend: {
       id: 'karma_legend',
       title: 'Karma Legend',
       description: 'Reach 1000 karma points',
       karma: 500
   },
   supporter: {
       id: 'supporter',
       title: 'Community Supporter',
       description: 'Make your first donation',
       karma: 100
   },
   philanthropist: {
       id: 'philanthropist',
       title: 'Philanthropist',
       description: 'Donate to charity',
       karma: 1000
   },
   cryptoWhale: {
       id: 'crypto_whale',
       title: 'Crypto Whale',
       description: 'Donate over $100',
       karma: 500
   },
   globalContributor: {
       id: 'global_contributor',
       title: 'Global Contributor',
       description: 'Share your first confession globally',
       karma: 100
   }
};

// State management
let currentPage = 1;
let currentCategory = 'all';
let currentSort = 'newest';
let searchQuery = '';
let selectedCategory = null;
let isSubmitting = false;
let userKarma = 0;
let userAchievements = [];
let userId = null;
let selectedDonationAmount = null;
let selectedPaymentMethod = null;
let donations = [];
let userDonations = [];
let currentTipConfessionId = null;
let isGlobalMode = false;
let firebaseInitialized = false;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
   initializeApp();
});

// Initialize Firebase when the script loads
let initFirebaseInterval;
function checkFirebaseLoaded() {
    if (window.firebaseServices) {
        clearInterval(initFirebaseInterval);
        initializeFirebase();
    }
}
initFirebaseInterval = setInterval(checkFirebaseLoaded, 100);

// Initialize Firebase
function initializeFirebase() {
    try {
        // Load settings from localStorage if available
        const savedSettings = localStorage.getItem('firebaseSettings');
        if (savedSettings) {
            Object.assign(FIREBASE_SETTINGS, JSON.parse(savedSettings));
        }
        
        updateConnectionStatus('connecting');
        
        // Check if the user's browser is online
        if (navigator.onLine) {
            firebaseInitialized = true;
            updateConnectionStatus('online');
            
            // Load Firebase data if global mode is active
            if (isGlobalMode) {
                loadGlobalConfessions();
            }
        } else {
            updateConnectionStatus('offline');
        }
        
        // Listen for online/offline events
        window.addEventListener('online', () => {
            updateConnectionStatus('online');
            if (isGlobalMode) {
                loadGlobalConfessions();
            }
        });
        
        window.addEventListener('offline', () => {
            updateConnectionStatus('offline');
            if (isGlobalMode) {
                // Switch back to local mode if offline
                toggleGlobalMode(false);
                showErrorMessage('You are offline. Switched to local mode.');
            }
        });
    } catch (error) {
        console.error("Firebase initialization error:", error);
        updateConnectionStatus('offline');
    }
}

// Update the connection status indicator
function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connection-status');
    statusElement.className = 'connection-status';
    
    if (status === 'online') {
        statusElement.classList.add('status-online');
        statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>Online (Global)</span>';
        setTimeout(() => {
            statusElement.style.opacity = '0.7';
        }, 3000);
    } else if (status === 'offline') {
        statusElement.classList.add('status-offline');
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Offline (Local Only)</span>';
    } else {
        statusElement.classList.add('status-connecting');
        statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Connecting...</span>';
    }
}

function initializeApp() {
   // Initialize user ID
   userId = localStorage.getItem('userId');
   if (!userId) {
       userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
       localStorage.setItem('userId', userId);
   }
   
   // Load user data
   loadUserData();
   loadDonationData();
   
   // Theme management
   const savedTheme = localStorage.getItem('theme') || 'light';
   document.documentElement.setAttribute('data-theme', savedTheme);
   updateThemeToggleIcon(savedTheme);
   
   // Check if global mode was previously enabled
   isGlobalMode = localStorage.getItem('globalMode') === 'true';
   
   // Event listeners
   document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
   document.getElementById('global-link').addEventListener('click', toggleGlobalMode);
   document.getElementById('confession-form').addEventListener('submit', handleConfessionSubmit);
   document.getElementById('random-confession').addEventListener('click', showRandomConfession);
   document.getElementById('admin-login').addEventListener('click', handleAdminLogin);
   document.getElementById('clear-all').addEventListener('click', clearAllConfessions);
   document.getElementById('sync-firebase').addEventListener('click', syncToFirebase);
   document.getElementById('save-firebase-settings').addEventListener('click', saveFirebaseSettings);
   document.getElementById('search-input').addEventListener('input', handleSearch);
   document.getElementById('sort-select').addEventListener('change', handleSortChange);
   document.getElementById('category-filter').addEventListener('change', handleCategoryFilterChange);
   document.getElementById('karma-display').addEventListener('click', showLeaderboard);
   document.getElementById('leaderboard-card').addEventListener('click', showLeaderboard);
   document.getElementById('donate-nav-btn').addEventListener('click', openDonationModal);
   document.getElementById('donate-submit-btn').addEventListener('click', processDonation);
   document.getElementById('charity-donation').addEventListener('change', toggleCharityDropdown);
   
   // Add event listener for wallet type selection
   document.getElementById('wallet-type').addEventListener('change', function() {
       const walletInput = document.getElementById('wallet-address');
       if (this.value) {
           walletInput.style.display = 'block';
           walletInput.placeholder = `Enter your ${this.options[this.selectedIndex].text} address`;
       } else {
           walletInput.style.display = 'none';
           walletInput.value = '';
       }
   });
   
   // Donation event listeners
   document.querySelectorAll('.amount-btn').forEach(btn => {
       btn.addEventListener('click', function() {
           selectDonationAmount(this);
       });
   });
   
   document.querySelectorAll('.payment-method').forEach(method => {
       method.addEventListener('click', function() {
           selectPaymentMethod(this);
       });
   });
   
   document.getElementById('custom-amount-input').addEventListener('input', function() {
       selectedDonationAmount = this.value;
       updateDonateButton();
   });
   
   // Close modal when clicking outside
   document.getElementById('leaderboard-modal').addEventListener('click', function(e) {
       if (e.target.className === 'modal') {
           this.style.display = 'none';
       }
   });
   
   document.getElementById('share-card-modal').addEventListener('click', function(e) {
       if (e.target.className === 'modal') {
           closeShareCardModal();
       }
   });
   
   document.getElementById('donation-modal').addEventListener('click', function(e) {
       if (e.target.className === 'donation-modal') {
           closeDonationModal();
       }
   });
   
   // Close modal buttons
   document.querySelectorAll('.close').forEach(closeBtn => {
       closeBtn.addEventListener('click', function() {
           const modal = this.closest('.modal, .donation-modal');
           if (modal) {
               if (modal.id === 'share-card-modal') {
                   closeShareCardModal();
               } else if (modal.id === 'donation-modal') {
                   closeDonationModal();
               } else {
                   modal.style.display = 'none';
               }
           }
       });
   });
   
   // Category tags
   document.querySelectorAll('.category-tag').forEach(tag => {
       tag.addEventListener('click', function() {
           document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
           this.classList.add('active');
           selectedCategory = this.dataset.category === 'all' ? null : this.dataset.category;
       });
   });
   
   // Character count
   const textArea = document.getElementById('confession-text');
   const charCount = document.querySelector('.character-count');
   
   textArea.addEventListener('input', function() {
       const count = this.value.length;
       charCount.textContent = `${count}/${MAX_CONFESSION_LENGTH} characters`;
       
       if (count > MAX_CONFESSION_LENGTH * 0.9) {
           charCount.classList.add('warning');
       } else {
           charCount.classList.remove('warning');
       }
   });
   
   // Navigation links
   document.getElementById('home-link').addEventListener('click', (e) => {
       e.preventDefault();
       window.scrollTo({ top: 0, behavior: 'smooth' });
   });

   // Find your global-link click handler and update it to this
document.getElementById('global-link').addEventListener('click', function(e) {
    e.preventDefault();
    isGlobalMode = !isGlobalMode;
    localStorage.setItem('globalMode', isGlobalMode);
    
    // Update UI
    this.textContent = isGlobalMode ? 'Local' : 'Global';
    
    // Clear and show loading indicator
    document.getElementById('confessions-list').innerHTML = 
        '<div class="loading"><i class="fas fa-spinner"></i></div>';
    
    // Load the appropriate data
    if (isGlobalMode) {
        console.log("Switching to GLOBAL mode");
        loadGlobalConfessions();
    } else {
        console.log("Switching to LOCAL mode");
        loadConfessions();
    }
});
   
   document.getElementById('about-link').addEventListener('click', (e) => {
       e.preventDefault();
       alert('Anonymous Confessions - A safe space to share your thoughts anonymously. Created with love for the community.');
   });
   
   document.getElementById('rules-link').addEventListener('click', (e) => {
       e.preventDefault();
       document.querySelector('.rules-banner').scrollIntoView({ behavior: 'smooth' });
   });
   
   // Check if admin access should be visible
   const isAdmin = sessionStorage.getItem('isAdmin');
   if (isAdmin) {
       document.getElementById('admin-access').style.display = 'block';
       document.getElementById('admin-panel').style.display = 'block';
       document.body.classList.add('admin-mode');
   }
   
   // Initial load
   loadConfessions();
   setConfessionOfDay();
   updateStatistics();
   updateFundingGoals();
   autoArchiveOldConfessions();
   checkSharedConfession();
   
   // Update stats every minute
   setInterval(updateStatistics, 60000);
   setInterval(updateFundingGoals, 300000); // Update funding goals every 5 minutes
   
   // Check for daily streak
   checkDailyStreak();
}

// Toggle between local and global mode
function toggleGlobalMode(force) {
    // If force parameter is provided, use it; otherwise toggle current state
    isGlobalMode = typeof force !== 'undefined' ? force : !isGlobalMode;
    
    // Store preference for future visits
    localStorage.setItem('globalMode', isGlobalMode);
    
    // Update UI to indicate current mode
    const globalLink = document.getElementById('global-link');
    if (isGlobalMode) {
        globalLink.innerHTML = 'Local';
        
        // Check if Firebase is available before loading global confessions
        if (!firebaseInitialized || !navigator.onLine) {
            isGlobalMode = false;
            localStorage.setItem('globalMode', false);
            showErrorMessage('Firebase is not available. Please check your connection.');
            return;
        }
        
        loadGlobalConfessions();
    } else {
        globalLink.innerHTML = 'Global';
        loadConfessions(); // Load local confessions
    }
    
    currentPage = 1; // Reset to first page when switching modes
    showSuccessMessage(isGlobalMode ? 'Switched to global mode' : 'Switched to local mode');
}

// Find this function in your code
async function loadGlobalConfessions() {
    try {
        const confessionsContainer = document.getElementById('confessions-list');
        confessionsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i></div>';
        
        // ADD THIS CHECK WITH CLEAR ERROR MESSAGE
        if (!window.firebaseServices) {
            confessionsContainer.innerHTML = '<div class="error">Firebase services not available. Please reload the page.</div>';
            console.error("Firebase services not available");
            return;
        }
        
        const { db, collection, getDocs, query, orderBy, limit, where } = window.firebaseServices;
        
        // Create a reference to the confessions collection
        const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
        
        // Build the query based on filters
        let firestoreQuery;
        
        // Apply category filter
        if (currentCategory !== 'all') {
            firestoreQuery = query(
                confessionsRef,
                where('category', '==', currentCategory),
                orderBy('timestamp', currentSort === 'oldest' ? 'asc' : 'desc'),
                limit(FIREBASE_SETTINGS.limit)
            );
        } else {
            // Apply sort filter
            if (currentSort === 'popular') {
                firestoreQuery = query(
                    confessionsRef,
                    orderBy('popularity', 'desc'),
                    limit(FIREBASE_SETTINGS.limit)
                );
            } else {
                firestoreQuery = query(
                    confessionsRef,
                    orderBy('timestamp', currentSort === 'oldest' ? 'asc' : 'desc'),
                    limit(FIREBASE_SETTINGS.limit)
                );
            }
        }
        
        // Execute the query
        const querySnapshot = await getDocs(firestoreQuery);
        
        // Process the results
        let confessions = [];
        querySnapshot.forEach((doc) => {
            const confession = {
                id: doc.id,
                ...doc.data()
            };
            confessions.push(confession);
        });
        
        // Apply search filter if needed
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            confessions = confessions.filter(c => c.text.toLowerCase().includes(query));
        }
        
        // Display the confessions
        displayConfessions(confessions);
    } catch (error) {
        console.error("Error loading global confessions:", error);
        showErrorMessage('Error loading global confessions. Check your connection.');
        confessionsContainer.innerHTML = '<div class="no-confessions"><i class="fas fa-exclamation-circle"></i>Error loading global confessions.</div>';
    }
}

// Sync local confessions to Firebase
async function syncToFirebase() {
    if (!window.firebaseServices) {
        showErrorMessage('Firebase services are not available');
        return;
    }
    
    const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
    
    // Get local confessions
    const localConfessions = JSON.parse(localStorage.getItem('confessions')) || [];
    
    // Confirm with the user
    if (!confirm(`Are you sure you want to sync ${localConfessions.length} local confessions to Firebase? This might take a while.`)) {
        return;
    }
    
    let successCount = 0;
    let errorCount = 0;
    
    try {
        // Create a reference to the confessions collection
        const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
        
        // Add each confession to Firebase
        for (const confession of localConfessions) {
            try {
                // Prepare the data for Firebase
                const firestoreData = {
                    text: confession.text,
                    category: confession.category || null,
                    userId: confession.userId,
                    timestamp: new Date(confession.timestamp).toISOString(),
                    views: confession.views || 0,
                    reactions: confession.reactions || {},
                    replies: confession.replies || [],
                    reported: confession.reported || false,
                    reports: confession.reports || 0,
                    tips: confession.tips || 0,
                    walletType: confession.walletType || null,
                    walletAddress: confession.walletAddress || null,
                    serverTimestamp: serverTimestamp(), // Add a server timestamp for sorting
                    popularity: calculatePopularity(confession),
                    isGlobal: true
                };
                
                // Add the document to Firestore
                await addDoc(confessionsRef, firestoreData);
                successCount++;
            } catch (error) {
                console.error("Error adding confession to Firebase:", error);
                errorCount++;
            }
        }
        
        showSuccessMessage(`Successfully synced ${successCount} confessions to Firebase. Errors: ${errorCount}`);
        
        // If in global mode, refresh the confessions
        if (isGlobalMode) {
            loadGlobalConfessions();
        }
    } catch (error) {
        console.error("Error syncing to Firebase:", error);
        showErrorMessage('Error syncing to Firebase. Check your connection.');
    }
}

// Calculate popularity score for a confession
function calculatePopularity(confession) {
    let score = 0;
    
    // Add points for views
    score += (confession.views || 0) * 0.1;
    
    // Add points for reactions
    if (confession.reactions) {
        // Sum all reactions
        const reactionsSum = Object.values(confession.reactions).reduce((sum, val) => sum + val, 0);
        score += reactionsSum * 5;
    }
    
    // Add points for replies
    if (confession.replies) {
        score += confession.replies.length * 10;
    }
    
    // Add points for tips
    score += (confession.tips || 0) * 20;
    
    return score;
}

// Save Firebase settings
function saveFirebaseSettings() {
    const collection = document.getElementById('firebase-collection').value;
    const limit = parseInt(document.getElementById('firebase-limit').value);
    
    if (!collection || isNaN(limit) || limit <= 0) {
        showErrorMessage('Please enter valid settings');
        return;
    }
    
    FIREBASE_SETTINGS.collection = collection;
    FIREBASE_SETTINGS.limit = limit;
    
    localStorage.setItem('firebaseSettings', JSON.stringify(FIREBASE_SETTINGS));
    showSuccessMessage('Firebase settings saved');
    
    // If in global mode, refresh the confessions
    if (isGlobalMode) {
        loadGlobalConfessions();
    }
}

// Donation System Functions
function openDonationModal() {
   document.getElementById('donation-modal').style.display = 'block';
   
   // Reset tip state if not tipping
   if (!currentTipConfessionId) {
       const titleElement = document.querySelector('.donation-title');
       const subtitleElement = document.querySelector('.donation-subtitle');
       
       if (titleElement) {
           titleElement.textContent = 'Support Our Community';
       }
       if (subtitleElement) {
           subtitleElement.textContent = 'Your support helps maintain this safe space for anonymous confessions';
       }
   }
   
   resetDonationForm();
}

function closeDonationModal() {
   document.getElementById('donation-modal').style.display = 'none';
   currentTipConfessionId = null;
   resetDonationForm();
}

function resetDonationForm() {
   document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('selected'));
   document.querySelectorAll('.payment-method').forEach(method => method.classList.remove('selected'));
   document.getElementById('custom-amount-container').style.display = 'none';
   document.getElementById('custom-amount-input').value = '';
   document.getElementById('donation-address').style.display = 'none';
   document.getElementById('charity-donation').checked = false;
   document.getElementById('charity-select').style.display = 'none';
   document.getElementById('charity-select').value = '';
   document.getElementById('donate-submit-btn').disabled = true;
   selectedDonationAmount = null;
   selectedPaymentMethod = null;
}

function selectDonationAmount(btn) {
   document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
   btn.classList.add('selected');
   
   const amount = btn.dataset.amount;
   if (amount === 'custom') {
       document.getElementById('custom-amount-container').style.display = 'block';
       selectedDonationAmount = document.getElementById('custom-amount-input').value;
   } else {
       document.getElementById('custom-amount-container').style.display = 'none';
       selectedDonationAmount = amount;
   }
   
   updateDonateButton();
}

function selectPaymentMethod(method) {
   document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
   method.classList.add('selected');
   selectedPaymentMethod = method.dataset.method;
   
   // Show payment address
   const addressDiv = document.getElementById('donation-address');
   addressDiv.innerHTML = `
       <div style="font-weight: 600; margin-bottom: 8px;">Send payment to:</div>
       <div style="margin-bottom: 10px;">${DONATION_ADDRESSES[selectedPaymentMethod]}</div>
       <button class="copy-address-btn" onclick="copyAddress('${DONATION_ADDRESSES[selectedPaymentMethod]}')">
           <i class="fas fa-copy"></i> Copy Address
       </button>
   `;
   addressDiv.style.display = 'block';
   
   updateDonateButton();
}

function copyAddress(address) {
   if (!address) {
       showErrorMessage('No address available');
       return;
   }
   
   navigator.clipboard.writeText(address).then(() => {
       showSuccessMessage('Address copied to clipboard!');
   }).catch(() => {
       // Fallback for browsers that don't support clipboard API
       const textArea = document.createElement('textarea');
       textArea.value = address;
       document.body.appendChild(textArea);
       textArea.select();
       try {
           document.execCommand('copy');
           showSuccessMessage('Address copied to clipboard!');
       } catch (err) {
           prompt('Copy this address:', address);
       }
       document.body.removeChild(textArea);
   });
}

function toggleCharityDropdown() {
    const charitySelect = document.getElementById('charity-select');
    if (document.getElementById('charity-donation').checked) {
        charitySelect.style.display = 'block';
    } else {
        charitySelect.style.display = 'none';
        charitySelect.value = '';
    }
 }
 
 function updateDonateButton() {
    const submitBtn = document.getElementById('donate-submit-btn');
    if (selectedDonationAmount && selectedPaymentMethod && parseFloat(selectedDonationAmount) > 0) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
 }
 
 function processDonation() {
    const amount = parseFloat(selectedDonationAmount);
    if (!amount || amount <= 0) {
        showErrorMessage('Please enter a valid donation amount');
        return;
    }
    
    const isCharity = document.getElementById('charity-donation').checked;
    const charityType = document.getElementById('charity-select').value;
    
    const donation = {
        id: 'donation_' + Date.now(),
        userId: userId,
        amount: amount,
        method: selectedPaymentMethod,
        isCharity: isCharity,
        charityType: charityType,
        timestamp: new Date().toISOString(),
        verified: false // In real app, this would be verified through payment confirmation
    };
    
    // Check if this is a tip for a specific confession
    if (currentTipConfessionId) {
        donation.type = 'tip';
        donation.confessionId = currentTipConfessionId;
        
        // Update the confession with the tip
        if (isGlobalMode && firebaseInitialized) {
            updateConfessionTipInFirebase(currentTipConfessionId, amount, userId);
        } else {
            let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
            const confessionIndex = confessions.findIndex(c => c.id === currentTipConfessionId);
            
            if (confessionIndex !== -1) {
                confessions[confessionIndex].tips = (confessions[confessionIndex].tips || 0) + amount;
                if (!confessions[confessionIndex].donors) {
                    confessions[confessionIndex].donors = [];
                }
                confessions[confessionIndex].donors.push(userId);
                localStorage.setItem('confessions', JSON.stringify(confessions));
                
                // Add karma to the confession owner
                const confessionOwner = confessions[confessionIndex].userId;
                if (confessionOwner && confessionOwner !== userId) {
                    addKarmaToUser(confessionOwner, KARMA_POINTS.donateMedium);
                }
            }
        }
    } else {
        donation.type = 'general';
    }
    
    // Save donation
    donations.push(donation);
    userDonations.push(donation);
    localStorage.setItem('donations', JSON.stringify(donations));
    localStorage.setItem('userDonations_' + userId, JSON.stringify(userDonations));
    
    // Update funding goals
    updateFundingGoalProgress(donation);
    
    // Award karma based on donation amount
    let karmaAwarded = 0;
    if (amount <= 10) {
        karmaAwarded = KARMA_POINTS.donateSmall;
    } else if (amount <= 50) {
        karmaAwarded = KARMA_POINTS.donateMedium;
    } else {
        karmaAwarded = KARMA_POINTS.donateLarge;
    }
    
    if (isCharity) {
        karmaAwarded += KARMA_POINTS.donateCharity;
    }
    
    addKarma(karmaAwarded, 'donation');
    
    // Check donation achievements
    checkDonationAchievements(donation);
    
    // Show thank you message
    showThankYouModal(amount, isCharity);
    
    // Reset tip confession ID
    currentTipConfessionId = null;
    
    closeDonationModal();
    
    // If in global mode and Firebase is available, also save the donation to Firebase
    if (isGlobalMode && firebaseInitialized) {
        saveDonationToFirebase(donation);
    }
    
    // Refresh the display
    if (isGlobalMode) {
        loadGlobalConfessions();
    } else {
        loadConfessions();
    }
 }
 
 // Update Firestore with tip information
 async function updateConfessionTipInFirebase(confessionId, amount, donorId) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, updateDoc } = window.firebaseServices;
         
         // Get a reference to the confession document
         const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
         
         // Update the document with the new tip amount and donor
         await updateDoc(confessionRef, {
             tips: amount, // This would ideally use a server-side increment operation
             donors: [donorId], // This would ideally use a server-side array union
             popularity: amount * 20 // Simple popularity boost based on tip amount
         });
         
         console.log(`Tip added to confession ${confessionId} in Firebase`);
     } catch (error) {
         console.error("Error updating tip in Firebase:", error);
         showErrorMessage('Error saving tip to Firebase. The tip was processed locally.');
     }
 }
 
 // Save donation to Firebase
 async function saveDonationToFirebase(donation) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
         
         // Create a reference to the donations collection
         const donationsRef = collection(db, FIREBASE_SETTINGS.donationCollection);
         
         // Prepare the data for Firebase
         const firestoreData = {
             ...donation,
             serverTimestamp: serverTimestamp()
         };
         
         // Add the document to Firestore
         await addDoc(donationsRef, firestoreData);
         
         console.log('Donation saved to Firebase');
     } catch (error) {
         console.error("Error saving donation to Firebase:", error);
     }
 }
 
 function showThankYouModal(amount, isCharity) {
    const modal = document.createElement('div');
    modal.className = 'donation-modal';
    modal.style.display = 'block';
    
    modal.innerHTML = `
        <div class="donation-modal-content thank-you-modal">
            <span class="close" onclick="this.closest('.donation-modal').remove()">&times;</span>
            <div class="thank-you-icon">
                <i class="fas fa-heart"></i>
            </div>
            <h2>Thank You for Your Support!</h2>
            <p>Your donation of $${amount} helps keep our community running.</p>
            ${isCharity ? '<p>10% of your donation will go to the selected charity.</p>' : ''}
            <p>You've earned karma points and are helping us reach our goals!</p>
            <button onclick="this.closest('.donation-modal').remove()" style="margin-top: 20px;">
                Close
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
 }
 
 function updateFundingGoalProgress(donation) {
    const amount = donation.amount;
    
    // Distribute donation to goals
    if (donation.isCharity) {
        FUNDING_GOALS.charity.current += amount * 0.1;
        FUNDING_GOALS.server.current += amount * 0.45;
        FUNDING_GOALS.feature.current += amount * 0.45;
    } else {
        FUNDING_GOALS.server.current += amount * 0.5;
        FUNDING_GOALS.feature.current += amount * 0.5;
    }
    
    localStorage.setItem('fundingGoals', JSON.stringify(FUNDING_GOALS));
    updateFundingGoals();
    
    // If in global mode and Firebase is available, also update funding goals in Firebase
    if (isGlobalMode && firebaseInitialized) {
        updateFundingGoalsInFirebase();
    }
 }
 
 // Update funding goals in Firebase
 async function updateFundingGoalsInFirebase() {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, setDoc } = window.firebaseServices;
         
         // Get a reference to the funding document
         const fundingRef = doc(db, FIREBASE_SETTINGS.fundingCollection, 'goals');
         
         // Update the document with the current funding goals
         await setDoc(fundingRef, FUNDING_GOALS);
         
         console.log('Funding goals updated in Firebase');
     } catch (error) {
         console.error("Error updating funding goals in Firebase:", error);
     }
 }
 
 function updateFundingGoals() {
    // Load saved goals
    const savedGoals = localStorage.getItem('fundingGoals');
    if (savedGoals) {
        Object.assign(FUNDING_GOALS, JSON.parse(savedGoals));
    }
    
    // Update server goal
    const serverProgress = Math.min((FUNDING_GOALS.server.current / FUNDING_GOALS.server.target) * 100, 100);
    document.getElementById('server-goal-progress').style.width = serverProgress + '%';
    document.getElementById('server-goal-progress').textContent = Math.round(serverProgress) + '%';
    document.getElementById('server-goal-raised').textContent = `$${Math.round(FUNDING_GOALS.server.current)} raised`;
    
    // Update feature goal
    const featureProgress = Math.min((FUNDING_GOALS.feature.current / FUNDING_GOALS.feature.target) * 100, 100);
    document.getElementById('feature-goal-progress').style.width = featureProgress + '%';
    document.getElementById('feature-goal-progress').textContent = Math.round(featureProgress) + '%';
    document.getElementById('feature-goal-raised').textContent = `$${Math.round(FUNDING_GOALS.feature.current)} raised`;
    
    // Update charity goal
    const charityProgress = Math.min((FUNDING_GOALS.charity.current / FUNDING_GOALS.charity.target) * 100, 100);
    document.getElementById('charity-goal-progress').style.width = charityProgress + '%';
    document.getElementById('charity-goal-progress').textContent = Math.round(charityProgress) + '%';
    document.getElementById('charity-goal-raised').textContent = `$${Math.round(FUNDING_GOALS.charity.current)} raised`;
 }
 
 function checkDonationAchievements(donation) {
    // First donation achievement
    if (userDonations.length === 1 && !userAchievements.includes('supporter')) {
        userAchievements.push('supporter');
        addKarma(ACHIEVEMENTS.supporter.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.supporter);
    }
    
    // Charity donation achievement
    if (donation.isCharity && !userAchievements.includes('philanthropist')) {
        userAchievements.push('philanthropist');
        addKarma(ACHIEVEMENTS.philanthropist.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.philanthropist);
    }
    
    // Large donation achievement
    if (donation.amount > 100 && !userAchievements.includes('crypto_whale')) {
        userAchievements.push('crypto_whale');
        addKarma(ACHIEVEMENTS.cryptoWhale.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.cryptoWhale);
    }
    
    saveUserData();
 }
 
 function loadDonationData() {
    const savedDonations = localStorage.getItem('donations');
    if (savedDonations) {
        donations = JSON.parse(savedDonations);
    }
    
    const savedUserDonations = localStorage.getItem('userDonations_' + userId);
    if (savedUserDonations) {
        userDonations = JSON.parse(savedUserDonations);
    }
 }
 
 function tipConfession(confessionId) {
    const confession = getConfessionById(confessionId);
    if (!confession) return;
    
    currentTipConfessionId = confessionId;
    openDonationModal();
    
    // Customize modal for tipping
    const titleElement = document.querySelector('.donation-title');
    const subtitleElement = document.querySelector('.donation-subtitle');
    
    if (titleElement) {
        titleElement.textContent = 'Tip This Confession';
    }
    
    if (subtitleElement) {
        if (confession.walletAddress && confession.walletType) {
            subtitleElement.innerHTML = `
                Direct tip to author's ${confession.walletType.toUpperCase()} wallet<br>
                <small style="font-family: monospace; word-break: break-all;">${confession.walletAddress}</small>
            `;
        } else {
            subtitleElement.textContent = 'Show appreciation for this confession (goes to platform)';
        }
    }
    
    // If confession has a wallet address, show it in the donation modal
    if (confession.walletAddress && confession.walletType) {
        const addressDiv = document.getElementById('donation-address');
        addressDiv.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">Send directly to author's wallet:</div>
            <div style="margin-bottom: 10px; word-break: break-all;">${confession.walletAddress}</div>
            <button class="copy-address-btn" onclick="copyAddress('${confession.walletAddress}')">
                <i class="fas fa-copy"></i> Copy Author's Address
            </button>
        `;
        addressDiv.style.display = 'block';
        
        // Pre-select the matching payment method
        const paymentMethods = document.querySelectorAll('.payment-method');
        paymentMethods.forEach(method => {
            if (method.dataset.method === confession.walletType) {
                selectPaymentMethod(method);
            }
        });
    }
 }
 
 // Theme and UI Functions
 function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeToggleIcon(newTheme);
 }
 
 function updateThemeToggleIcon(theme) {
    const iconElement = document.querySelector('#theme-toggle i');
    if (theme === 'dark') {
        iconElement.className = 'fas fa-sun';
    } else {
        iconElement.className = 'fas fa-moon';
    }
 }
 
 // User Data Management
 function loadUserData() {
    const userData = localStorage.getItem('userData_' + userId);
    if (userData) {
        const data = JSON.parse(userData);
        userKarma = data.karma || 0;
        userAchievements = data.achievements || [];
    }
    updateKarmaDisplay();
 }
 
 function saveUserData() {
    const userData = {
        karma: userKarma,
        achievements: userAchievements,
        lastSubmissionDate: new Date().toDateString()
    };
    localStorage.setItem('userData_' + userId, JSON.stringify(userData));
    
    // If in global mode and Firebase is available, also save user data to Firebase
    if (isGlobalMode && firebaseInitialized) {
        saveUserDataToFirebase(userData);
    }
 }
 
 // Save user data to Firebase
 async function saveUserDataToFirebase(userData) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, setDoc } = window.firebaseServices;
         
         // Get a reference to the user document
         const userRef = doc(db, FIREBASE_SETTINGS.userCollection, userId);
         
         // Update the document with the user data
         await setDoc(userRef, {
             ...userData,
             lastSynced: new Date().toISOString()
         });
         
         console.log('User data saved to Firebase');
     } catch (error) {
         console.error("Error saving user data to Firebase:", error);
     }
 }
 
 function updateKarmaDisplay() {
    document.getElementById('user-karma').textContent = userKarma;
 }
 
 function addKarma(points, reason) {
    userKarma += points;
    updateKarmaDisplay();
    saveUserData();
    checkAchievements();
 }
 
 function showAchievement(achievement) {
    const popup = document.getElementById('achievement-popup');
    document.getElementById('achievement-title').textContent = achievement.title;
    document.getElementById('achievement-description').textContent = achievement.description;
    
    popup.classList.add('show');
    
    setTimeout(() => {
        popup.classList.remove('show');
    }, 5000);
 }
 
 function checkAchievements() {
    // Check for various achievements
    
    // Check for first confession achievement
    const confessions = isGlobalMode ? [] : (JSON.parse(localStorage.getItem('confessions')) || []);
    const userConfessions = confessions.filter(c => c.userId === userId);
    
    if (userConfessions.length === 1 && !userAchievements.includes('first_confession')) {
        userAchievements.push('first_confession');
        addKarma(ACHIEVEMENTS.firstConfession.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.firstConfession);
    }
    
    // Check for karma legend achievement
    if (userKarma >= 1000 && !userAchievements.includes('karma_legend')) {
        userAchievements.push('karma_legend');
        addKarma(ACHIEVEMENTS.karmaLegend.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.karmaLegend);
    }
    
    saveUserData();
 }
 
 function checkDailyStreak() {
    const userData = localStorage.getItem('userData_' + userId);
    if (userData) {
        const data = JSON.parse(userData);
        const lastSubmission = data.lastSubmissionDate;
        const today = new Date().toDateString();
        
        if (lastSubmission && lastSubmission !== today) {
            // Check if it's consecutive days
            const lastDate = new Date(lastSubmission);
            const diffTime = Math.abs(new Date() - lastDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                // Consecutive day
                const currentStreak = (data.currentStreak || 0) + 1;
                data.currentStreak = currentStreak;
                
                if (currentStreak === 7 && !userAchievements.includes('daily_streak')) {
                    userAchievements.push('daily_streak');
                    addKarma(ACHIEVEMENTS.dailyStreak.karma, 'achievement');
                    showAchievement(ACHIEVEMENTS.dailyStreak);
                }
            } else {
                // Streak broken
                data.currentStreak = 0;
            }
            
            localStorage.setItem('userData_' + userId, JSON.stringify(data));
        }
    }
 }
 
 function handleConfessionSubmit(e) {
    e.preventDefault();
    
    if (isSubmitting) return;
    
    const confessionText = document.getElementById('confession-text').value.trim();
    const submitBtn = document.getElementById('submit-btn');
    const shareGlobally = document.getElementById('share-globally').checked;
    
    if (!confessionText) {
        showErrorMessage('Please enter a confession');
        return;
    }
    
    // Basic content moderation
    if (containsForbiddenWords(confessionText)) {
        showErrorMessage('Your confession contains inappropriate content. Please revise and try again.');
        return;
    }
    
    // Check if trying to share globally but Firebase is not available
    if (shareGlobally && (!firebaseInitialized || !navigator.onLine)) {
        showErrorMessage('Cannot share globally. Please check your connection or try again later.');
        return;
    }
    
    isSubmitting = true;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    // Simulate API call
    setTimeout(() => {
        if (shareGlobally) {
            addGlobalConfession(confessionText, selectedCategory);
        } else {
            addLocalConfession(confessionText, selectedCategory);
        }
        
        document.getElementById('confession-text').value = '';
        document.querySelector('.character-count').textContent = '0/1000 characters';
        showSuccessMessage(shareGlobally ? 'Your confession has been shared globally!' : 'Your confession has been submitted successfully!');
        
        // Reset category selection
        document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
        document.querySelector('.category-tag[data-category="all"]').classList.add('active');
        selectedCategory = null;
        
        // Reset wallet fields
        document.getElementById('wallet-type').value = '';
        document.getElementById('wallet-address').value = '';
        document.getElementById('wallet-address').style.display = 'none';
        
        // Reset global sharing checkbox
        document.getElementById('share-globally').checked = false;
        
        // Add karma for submission
        addKarma(KARMA_POINTS.submitConfession, 'submission');
        
        // Add karma for global contribution if shared globally
        if (shareGlobally && !userAchievements.includes('global_contributor')) {
            userAchievements.push('global_contributor');
            addKarma(ACHIEVEMENTS.globalContributor.karma, 'achievement');
            showAchievement(ACHIEVEMENTS.globalContributor);
        }
        
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Confession';
        
        // Refresh the confessions list
        if (isGlobalMode && shareGlobally) {
            loadGlobalConfessions();
        } else if (!isGlobalMode && !shareGlobally) {
            loadConfessions();
        }
    }, 1000);
 }
 
 function containsForbiddenWords(text) {
    const lowerText = text.toLowerCase();
    return FORBIDDEN_WORDS.some(word => lowerText.includes(word));
 }
 
 function showSuccessMessage(message = 'Your confession has been submitted successfully!') {
    const successMessage = document.getElementById('success-message');
    if (message !== 'Your confession has been submitted successfully!') {
        successMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    } else {
        successMessage.innerHTML = `<i class="fas fa-check-circle"></i> Your confession has been submitted successfully!`;
    }
    successMessage.style.display = 'flex';
    
    setTimeout(() => {
        successMessage.style.display = 'none';
    }, 3000);
 }
 
 function showErrorMessage(message) {
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    errorText.textContent = message;
    errorMessage.style.display = 'flex';
    
    setTimeout(() => {
        errorMessage.style.display = 'none';
    }, 3000);
 }
 
 // Add a confession to Firebase
 async function addGlobalConfession(text, category = null) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, collection, addDoc, serverTimestamp } = window.firebaseServices;
         
         const walletType = document.getElementById('wallet-type').value;
         const walletAddress = document.getElementById('wallet-address').value.trim();
         
         // Create a reference to the confessions collection
         const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
         
         // Prepare the confession data
         const confession = {
             text: text,
             category: category,
             userId: userId,
             timestamp: new Date().toISOString(),
             views: 0,
             reactions: {
                 like: 0,
                 dislike: 0,
                 love: 0,
                 haha: 0,
                 wow: 0,
                 sad: 0
             },
             replies: [],
             reports: 0,
             reported: false,
             tips: 0,
             donors: [],
             walletType: walletType || null,
             walletAddress: walletAddress || null,
             serverTimestamp: serverTimestamp(),
             popularity: 0,
             isGlobal: true
         };
         
         // Add the document to Firestore
         const docRef = await addDoc(confessionsRef, confession);
         console.log('Confession added to Firebase with ID:', docRef.id);
         
         // Also save locally for offline access
         saveConfessionLocally({
             ...confession,
             id: docRef.id
         });
         
         // Check if we need to set a new confession of the day
         const lastUpdate = localStorage.getItem('last_cotd_update');
         if (!lastUpdate) {
             setConfessionOfDay();
         }
         
         checkDailyStreak();
         checkAchievements();
         
         return true;
     } catch (error) {
         console.error("Error adding confession to Firebase:", error);
         showErrorMessage("Error sharing globally. The confession was saved locally.");
         
         // Fallback to local storage
         addLocalConfession(text, category);
         return false;
     }
 }
 
 // Save a copy of a global confession to local storage
 function saveConfessionLocally(confession) {
     let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
     confessions.unshift(confession);
     localStorage.setItem('confessions', JSON.stringify(confessions));
 }
 
 function addLocalConfession(text, category = null) {
    try {
        const walletType = document.getElementById('wallet-type').value;
        const walletAddress = document.getElementById('wallet-address').value.trim();
        
        const confession = {
            id: 'conf_' + Date.now(),
            userId: userId,
            text: text,
            category: category,
            timestamp: new Date().toISOString(),
            views: 0,
            reactions: {
                like: 0,
                dislike: 0,
                love: 0,
                haha: 0,
                wow: 0,
                sad: 0
            },
            replies: [],
            reports: 0,
            reported: false,
            tips: 0,
            donors: [],
            walletType: walletType || null,
            walletAddress: walletAddress || null,
            isGlobal: false
        };
        
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        confessions.unshift(confession);
        
        localStorage.setItem('confessions', JSON.stringify(confessions));
        
        // Check if we need to set a new confession of the day
        const lastUpdate = localStorage.getItem('last_cotd_update');
        if (!lastUpdate) {
            setConfessionOfDay();
        }
        
        loadConfessions();
        updateStatistics();
        checkDailyStreak();
        checkAchievements();
        
        return true;
    } catch (error) {
        console.error("Error adding confession:", error);
        showErrorMessage("There was an error saving your confession. Please try again.");
        return false;
    }
 }
 
 function loadConfessions() {
    try {
        const confessionsContainer = document.getElementById('confessions-list');
        let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        
        // Apply filters
        confessions = applyFilters(confessions);
        
        // Calculate pagination
        const totalPages = Math.ceil(confessions.length / CONFESSIONS_PER_PAGE);
        const start = (currentPage - 1) * CONFESSIONS_PER_PAGE;
        const end = start + CONFESSIONS_PER_PAGE;
        const pageConfessions = confessions.slice(start, end);
        
        displayConfessions(pageConfessions, totalPages);
    } catch (error) {
        console.error("Error in loadConfessions:", error);
        document.getElementById('confessions-list').innerHTML = '<div class="error">Error loading confessions. Please refresh the page.</div>';
    }
 }
 
 function displayConfessions(confessions, totalPages) {
     const confessionsContainer = document.getElementById('confessions-list');
     
     if (confessions.length === 0) {
         confessionsContainer.innerHTML = '<div class="no-confessions"><i class="fas fa-feather"></i>No confessions found.</div>';
         document.getElementById('pagination').innerHTML = '';
         return;
     }
     
     confessionsContainer.innerHTML = '';
     
     confessions.forEach(confession => {
         const confessionElement = createConfessionElement(confession);
         confessionsContainer.appendChild(confessionElement);
         incrementViewCount(confession.id);
     });
     
     // Create pagination if totalPages is provided
     if (totalPages) {
         createPagination(totalPages);
     }
 }
 
 function applyFilters(confessions) {
    let filtered = [...confessions];
    
    // Category filter
    if (currentCategory !== 'all') {
        filtered = filtered.filter(c => c.category === currentCategory);
    }
    
    // Search filter
    if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(c => c.text.toLowerCase().includes(query));
    }
    
    // Sort
    switch (currentSort) {
        case 'oldest':
            filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            break;
        case 'popular':
            filtered.sort((a, b) => {
                const aReactions = Object.values(a.reactions || {}).reduce((sum, val) => sum + val, 0);
                const bReactions = Object.values(b.reactions || {}).reduce((sum, val) => sum + val, 0);
                return bReactions - aReactions;
            });
            break;
        default: // newest
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }
    
    return filtered;
 }
 
 function createConfessionElement(confession) {
    const confessionElement = document.createElement('div');
    confessionElement.className = `confession ${confession.reported ? 'reported' : ''}`;
    confessionElement.setAttribute('data-id', confession.id);
    
    const categoryBadge = confession.category ? 
        `<span class="category-badge" style="background-color: var(--primary-light); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block;">${confession.category}</span>` : '';
    
    const totalReactions = Object.values(confession.reactions || {}).reduce((sum, val) => sum + val, 0);
    
    // Check if user is a donor
    const isDonor = userDonations.length > 0;
    const donorBadge = isDonor ? '<span class="donor-badge"><i class="fas fa-gem"></i> Donor</span>' : '';
   
    // Check if confession has received tips
    const tipAmount = confession.tips || 0;
    const tipBadge = tipAmount > 0 ? `<span class="tip-badge" style="background: var(--success-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">$${tipAmount} tipped</span>` : '';
    
    // Show wallet badge if author accepts tips
    const walletBadge = confession.walletAddress ? 
        `<span class="wallet-badge" style="background: var(--crypto-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">
            <i class="fas fa-wallet"></i> ${confession.walletType} Tips
        </span>` : '';
    
    // Global badge for confessions shared globally
    const globalBadge = confession.isGlobal ? 
        `<span class="global-badge">
            <i class="fas fa-globe"></i> Global
        </span>` : '';
    
    // Update tip button based on wallet status
    const tipButtonText = confession.walletAddress ? 
        '<i class="fas fa-hand-holding-usd"></i> Tip Author' : 
        '<i class="fas fa-hand-holding-usd"></i> Tip';
    
    confessionElement.innerHTML = `
        ${categoryBadge}
        <p>${confession.text}</p>
        <div class="meta">
            <div class="meta-info">
                <div class="timestamp">
                    <i class="far fa-clock"></i> ${formatDate(new Date(confession.timestamp))}
                    ${donorBadge}
                    ${tipBadge}
                    ${walletBadge}
                    ${globalBadge}
                </div>
                <div class="views">
                    <i class="far fa-eye"></i> ${confession.views || 0} views
                </div>
            </div>
            <div class="actions">
                ${createReactionButtons(confession)}
                <button class="tip-button" onclick="tipConfession('${confession.id}')">
                    ${tipButtonText}
                </button>
                <button class="share-button" onclick="openShareOptions(event, '${confession.id}')">
                    <i class="fas fa-share-alt"></i>
                </button>
                <div class="share-options" id="share-options-${confession.id}">
                    <button class="share-option-btn" onclick="shareToTwitter('${confession.id}')">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="share-option-btn" onclick="copyShareLink('${confession.id}')">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                    <button class="share-option-btn" onclick="createShareCard('${confession.id}')">
                        <i class="fas fa-image"></i> Create Card
                    </button>
                </div>
                <button class="report-button" onclick="reportConfession('${confession.id}')">
                    <i class="fas fa-flag"></i>
                </button>
            </div>
        </div>
        ${createRepliesSection(confession)}
        <button class="admin-action" onclick="deleteConfession('${confession.id}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Check if this confession is popular enough for achievement
    if (totalReactions >= 50 && confession.userId === userId && !userAchievements.includes('popular_confession')) {
        userAchievements.push('popular_confession');
        addKarma(ACHIEVEMENTS.popularConfession.karma, 'achievement');
        showAchievement(ACHIEVEMENTS.popularConfession);
    }
    
    return confessionElement;
 }
 
 function createReactionButtons(confession) {
    const reactions = [
        { name: 'like', icon: 'fas fa-thumbs-up' },
        { name: 'dislike', icon: 'fas fa-thumbs-down' },
        { name: 'love', icon: 'fas fa-heart' },
        { name: 'haha', icon: 'fas fa-laugh' },
        { name: 'wow', icon: 'fas fa-surprise' },
        { name: 'sad', icon: 'fas fa-sad-tear' }
    ];
    
    return reactions.map(reaction => {
        const count = confession.reactions ? (confession.reactions[reaction.name] || 0) : 0;
        return `<button class="react-button ${reaction.name}" onclick="reactToConfession('${confession.id}', '${reaction.name}')">
            <i class="${reaction.icon}"></i> <span class="reaction-count">${count}</span>
        </button>`;
    }).join('');
 }
 
 function createRepliesSection(confession) {
    const replies = confession.replies || [];
    const replyCount = replies.length;
    
    return `
        <div class="replies-section">
            <button class="replies-toggle" onclick="toggleReplies('${confession.id}')">
                <i class="fas fa-comments"></i>
                Replies <span class="reply-count">(${replyCount})</span>
            </button>
            <div class="replies-container" id="replies-${confession.id}">
                ${replies.map(reply => `
                    <div class="reply">
                        <p>${reply.text}</p>
                        <div class="reply-meta">
                            <span class="reply-timestamp">${formatDate(new Date(reply.timestamp))}</span>
                        </div>
                    </div>
                `).join('')}
                <div class="reply-form">
                    <textarea class="reply-input" placeholder="Write a reply..." id="reply-input-${confession.id}"></textarea>
                    <button class="reply-submit" onclick="submitReply('${confession.id}')">Reply</button>
                </div>
            </div>
        </div>
    `;
 }
 
 function toggleReplies(confessionId) {
    const repliesContainer = document.getElementById(`replies-${confessionId}`);
    repliesContainer.classList.toggle('active');
 }
 
 function submitReply(confessionId) {
    const replyInput = document.getElementById(`reply-input-${confessionId}`);
    const replyText = replyInput.value.trim();
    
    if (!replyText) return;
    
    // Check if this is a global confession
    if (isGlobalMode && firebaseInitialized) {
        submitReplyToFirebase(confessionId, replyText);
    } else {
        submitLocalReply(confessionId, replyText);
    }
    
    replyInput.value = '';
 }
 
 // Submit reply to Firebase
 async function submitReplyToFirebase(confessionId, replyText) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, updateDoc, arrayUnion } = window.firebaseServices;
         
         const reply = {
             id: 'reply_' + Date.now(),
             text: replyText,
             timestamp: new Date().toISOString(),
             userId: userId
         };
         
         // Get a reference to the confession document
         const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
         
         // Update the document with the new reply
         await updateDoc(confessionRef, {
             replies: arrayUnion(reply)
         });
         
         console.log(`Reply added to confession ${confessionId} in Firebase`);
         
         // Refresh the confessions
         loadGlobalConfessions();
     } catch (error) {
         console.error("Error submitting reply to Firebase:", error);
         showErrorMessage('Error submitting reply to Firebase. Trying locally...');
         
         // Fallback to local storage
         submitLocalReply(confessionId, replyText);
     }
 }
 
 function submitLocalReply(confessionId, replyText) {
    const reply = {
        id: 'reply_' + Date.now(),
        text: replyText,
        timestamp: new Date().toISOString(),
        userId: userId
    };
    
    let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const confessionIndex = confessions.findIndex(c => c.id === confessionId);
    
    if (confessionIndex !== -1) {
        if (!confessions[confessionIndex].replies) {
            confessions[confessionIndex].replies = [];
        }
        
        confessions[confessionIndex].replies.push(reply);
        localStorage.setItem('confessions', JSON.stringify(confessions));
        
        // Add karma to the confession owner if they receive a reply
        const confessionOwner = confessions[confessionIndex].userId;
        if (confessionOwner && confessionOwner !== userId) {
            addKarmaToUser(confessionOwner, KARMA_POINTS.receiveReply);
        }
        
        // Check for conversation starter achievement
        if (confessions[confessionIndex].replies.length >= 10 && 
            confessions[confessionIndex].userId === userId && 
            !userAchievements.includes('conversation_starter')) {
            userAchievements.push('conversation_starter');
            addKarma(ACHIEVEMENTS.conversationStarter.karma, 'achievement');
            showAchievement(ACHIEVEMENTS.conversationStarter);
        }
        
        loadConfessions();
    }
 }
 
 function addKarmaToUser(targetUserId, points) {
    const userData = localStorage.getItem('userData_' + targetUserId);
    if (userData) {
        const data = JSON.parse(userData);
        data.karma = (data.karma || 0) + points;
        localStorage.setItem('userData_' + targetUserId, JSON.stringify(data));
    }
 }
 
 function openShareOptions(event, confessionId) {
    event.stopPropagation();
    const shareOptions = document.getElementById(`share-options-${confessionId}`);
    
    // Close all other share options
    document.querySelectorAll('.share-options').forEach(el => {
        if (el !== shareOptions) {
            el.classList.remove('active');
        }
    });
    
    shareOptions.classList.toggle('active');
    
    // Position the share options properly
    const button = event.currentTarget;
    shareOptions.style.top = `${button.offsetHeight + 5}px`;
    shareOptions.style.right = '0';
    
    // Close share options when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function closeShareOptions(e) {
            if (!shareOptions.contains(e.target) && e.target !== button) {
                shareOptions.classList.remove('active');
                document.removeEventListener('click', closeShareOptions);
            }
        });
    }, 100);
 }
 
 function shareToTwitter(confessionId) {
    const confession = getConfessionById(confessionId);
    if (confession) {
        const text = confession.text.substring(0, 200) + (confession.text.length > 200 ? '...' : '');
        const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=confession,anonymous`;
        window.open(twitterUrl, '_blank');
    }
 }
 
 function copyShareLink(confessionId) {
    const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
    navigator.clipboard.writeText(url).then(() => {
        showSuccessMessage('Link copied to clipboard!');
    }).catch(() => {
        prompt('Copy this link:', url);
    });
 }
 
 function createShareCard(confessionId) {
    const confession = getConfessionById(confessionId);
    if (!confession) return;
    
    // Update share card content
    document.getElementById('share-card-text').textContent = confession.text;
    document.getElementById('share-card-date').textContent = formatDate(new Date(confession.timestamp));
    
    const totalReactions = Object.values(confession.reactions || {}).reduce((sum, val) => sum + val, 0);
    document.getElementById('share-card-stats').innerHTML = `
        <span><i class="fas fa-heart"></i> ${totalReactions}</span>
        <span><i class="fas fa-eye"></i> ${confession.views || 0}</span>
    `;
    
    // Generate QR code
    const qrContainer = document.getElementById('share-card-qr');
    qrContainer.innerHTML = '';
    const url = `${window.location.origin}${window.location.pathname}?confession=${confessionId}`;
    new QRCode(qrContainer, {
        text: url,
        width: 80,
        height: 80
    });
    
    // Create image preview
    setTimeout(() => {
        const shareCard = document.querySelector('#share-card-canvas .share-card');
        html2canvas(shareCard).then(canvas => {
            // Show preview in modal
            const modal = document.getElementById('share-card-modal');
            const previewContainer = document.getElementById('share-card-preview');
            previewContainer.innerHTML = '';
            
            // Create image element from canvas
            const image = new Image();
            image.src = canvas.toDataURL('image/png');
            image.style.maxWidth = '100%';
            image.style.borderRadius = '8px';
            image.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            
            previewContainer.appendChild(image);
            
            // Store the image data for potential download
            window.currentShareCardData = canvas.toDataURL('image/png');
            window.currentShareCardId = confessionId;
            
            // Show the modal
            modal.style.display = 'block';
        });
    }, 100);
 }
 
 function getConfessionById(confessionId) {
    if (isGlobalMode && firebaseInitialized) {
        // For global mode, we might need to fetch from Firebase
        // This should be implemented with caching for better performance
        const cachedConfessions = JSON.parse(localStorage.getItem('confessions')) || [];
        return cachedConfessions.find(c => c.id === confessionId);
    } else {
        const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
        return confessions.find(c => c.id === confessionId);
    }
 }
 
 function showLeaderboard() {
    const modal = document.getElementById('leaderboard-modal');
    const content = document.getElementById('leaderboard-content');
    
    modal.style.display = 'block';
    content.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i></div>';
    
    if (isGlobalMode && firebaseInitialized) {
        loadGlobalLeaderboard().then(users => {
            displayLeaderboard(users);
        }).catch(error => {
            console.error("Error loading global leaderboard:", error);
            
            // Fallback to local leaderboard
            const localUsers = getLocalLeaderboardData();
            displayLeaderboard(localUsers);
        });
    } else {
        // Load local leaderboard
        const users = getLocalLeaderboardData();
        displayLeaderboard(users);
    }
 }
 
 // Load global leaderboard from Firebase
 async function loadGlobalLeaderboard() {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, collection, getDocs, query, orderBy, limit } = window.firebaseServices;
         
         // Create a reference to the users collection
         const usersRef = collection(db, FIREBASE_SETTINGS.userCollection);
         
         // Create a query to get the top users by karma
         const usersQuery = query(
             usersRef,
             orderBy('karma', 'desc'),
             limit(10)
         );
         
         // Execute the query
         const querySnapshot = await getDocs(usersQuery);
         
         // Process the results
         let users = [];
         querySnapshot.forEach((doc) => {
             const userData = doc.data();
             users.push({
                 id: doc.id,
                 karma: userData.karma || 0,
                 achievements: userData.achievements || [],
                 totalDonated: 0 // We would need to calculate this from donation records
             });
         });
         
         return users;
     } catch (error) {
         console.error("Error loading global leaderboard:", error);
         throw error;
     }
 }
 
 // Get local leaderboard data
 function getLocalLeaderboardData() {
    const users = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('userData_')) {
            const userData = JSON.parse(localStorage.getItem(key));
            const userId = key.replace('userData_', '');
            const userDonations = JSON.parse(localStorage.getItem('userDonations_' + userId) || '[]');
            const totalDonated = userDonations.reduce((sum, d) => sum + d.amount, 0);
            
            users.push({
                id: userId,
                karma: userData.karma || 0,
                achievements: userData.achievements || [],
                totalDonated: totalDonated
            });
        }
    }
    
    // Sort by karma
    users.sort((a, b) => b.karma - a.karma);
    
    return users;
 }
 
 // Display leaderboard data
 function displayLeaderboard(users) {
    const content = document.getElementById('leaderboard-content');
    
    content.innerHTML = users.slice(0, 10).map((user, index) => {
        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
        const donorBadge = user.totalDonated > 0 ? '<span class="donor-badge"><i class="fas fa-gem"></i></span>' : '';
        
        return `
            <div class="leaderboard-item">
                <span class="rank ${rankClass}">#${index + 1}</span>
                <div class="user-info">
                    <span class="user-name">Anonymous User ${user.id.substr(-4)}${donorBadge}</span>
                    <div class="user-achievements">
                        ${user.achievements.length} achievements | $${user.totalDonated} donated
                    </div>
                </div>
                <span class="karma-badge">${user.karma} karma</span>
            </div>
        `;
    }).join('');
 }
 
 function reactToConfession(confessionId, reactionType) {
    try {
        if (isGlobalMode && firebaseInitialized) {
            reactToGlobalConfession(confessionId, reactionType);
        } else {
            reactToLocalConfession(confessionId, reactionType);
        }
    } catch (error) {
        console.error("Error in reactToConfession:", error);
    }
 }
 
 // React to global confession in Firebase
 async function reactToGlobalConfession(confessionId, reactionType) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, updateDoc, increment } = window.firebaseServices;
         
         // Get a reference to the confession document
         const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
         
         // Update the document with the new reaction count
         await updateDoc(confessionRef, {
             [`reactions.${reactionType}`]: increment(1)
         });
         
         console.log(`Reaction added to confession ${confessionId} in Firebase`);
         
         // Refresh the confessions
         loadGlobalConfessions();
     } catch (error) {
         console.error("Error reacting to global confession:", error);
         showErrorMessage("Error adding reaction. The reaction was processed locally.");
         
         // Fallback to local storage
         reactToLocalConfession(confessionId, reactionType);
     }
 }
 
 function reactToLocalConfession(confessionId, reactionType) {
    let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const confessionIndex = confessions.findIndex(c => c.id === confessionId);
    
    if (confessionIndex !== -1) {
        if (!confessions[confessionIndex].reactions) {
            confessions[confessionIndex].reactions = {
                like: 0,
                dislike: 0,
                love: 0,
                haha: 0,
                wow: 0,
                sad: 0
            };
        }
        
        confessions[confessionIndex].reactions[reactionType]++;
        localStorage.setItem('confessions', JSON.stringify(confessions));
        
        // Add karma to the confession owner
        const confessionOwner = confessions[confessionIndex].userId;
        if (confessionOwner && confessionOwner !== userId) {
            // Give extra karma for love reactions
            const karmaPoints = reactionType === 'love' ? KARMA_POINTS.receiveLove : KARMA_POINTS.receiveReaction;
            addKarmaToUser(confessionOwner, karmaPoints);
        }
        
        loadConfessions();
    }
 }
 
 function createPagination(totalPages) {
    const paginationContainer = document.getElementById('pagination');
    paginationContainer.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'page-btn';
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    paginationContainer.appendChild(prevBtn);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => changePage(i);
            paginationContainer.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.margin = '0 5px';
            paginationContainer.appendChild(ellipsis);
        }
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'page-btn';
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    paginationContainer.appendChild(nextBtn);
 }
 
 function changePage(page) {
    currentPage = page;
    
    if (isGlobalMode) {
        loadGlobalConfessions();
    } else {
        loadConfessions();
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
 }
 
 function formatDate(date) {
    try {
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffSec < 60) {
            return 'just now';
        } else if (diffMin < 60) {
            return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
        } else if (diffHour < 24) {
            return `${diffHour} hour${diffHour === 1 ? '' : 's'} ago`;
        } else {
            return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
        }
    } catch (error) {
        console.error("Error formatting date:", error);
        return "unknown time";
    }
 }
 
 function reportConfession(confessionId) {
    try {
        if (isGlobalMode && firebaseInitialized) {
            reportGlobalConfession(confessionId);
        } else {
            reportLocalConfession(confessionId);
        }
    } catch (error) {
        console.error("Error in reportConfession:", error);
    }
 }
 
 // Report global confession in Firebase
 async function reportGlobalConfession(confessionId) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, updateDoc, increment } = window.firebaseServices;
         
         // Get a reference to the confession document
         const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
         
         // Update the document with the report
         await updateDoc(confessionRef, {
             reports: increment(1),
             reported: true // Auto-flag as reported
         });
         
         console.log(`Confession ${confessionId} reported in Firebase`);
         
         // Refresh the confessions
         loadGlobalConfessions();
         
         alert('Thank you for reporting. We will review this confession.');
     } catch (error) {
         console.error("Error reporting global confession:", error);
         showErrorMessage("Error reporting confession. The report was processed locally.");
         
         // Fallback to local storage
         reportLocalConfession(confessionId);
     }
 }
 
 function reportLocalConfession(confessionId) {
    let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    const confessionIndex = confessions.findIndex(c => c.id === confessionId);
    
    if (confessionIndex !== -1) {
        if (!confessions[confessionIndex].reports) {
            confessions[confessionIndex].reports = 0;
        }
        
        confessions[confessionIndex].reports++;
        
        // Auto-hide after 5 reports
        if (confessions[confessionIndex].reports >= 5) {
            confessions[confessionIndex].reported = true;
        }
        
        localStorage.setItem('confessions', JSON.stringify(confessions));
        loadConfessions();
        alert('Thank you for reporting. We will review this confession.');
    }
 }
 
 function deleteConfession(confessionId) {
    if (confirm('Are you sure you want to delete this confession?')) {
        if (isGlobalMode && firebaseInitialized) {
            deleteGlobalConfession(confessionId);
        } else {
            deleteLocalConfession(confessionId);
        }
    }
 }
 
 // Delete confession from Firebase
 async function deleteGlobalConfession(confessionId) {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, doc, deleteDoc } = window.firebaseServices;
         
         // Get a reference to the confession document
         const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
         
         // Delete the document
         await deleteDoc(confessionRef);
         
         console.log(`Confession ${confessionId} deleted from Firebase`);
         
         // Also delete from local storage for synced state
         deleteLocalConfession(confessionId, false);
         
         // Refresh the confessions
         loadGlobalConfessions();
     } catch (error) {
         console.error("Error deleting global confession:", error);
         showErrorMessage("Error deleting confession. The deletion was processed locally.");
         
         // Fallback to local storage
         deleteLocalConfession(confessionId);
     }
 }
 
 function deleteLocalConfession(confessionId, reload = true) {
    let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
    confessions = confessions.filter(c => c.id !== confessionId);
    localStorage.setItem('confessions', JSON.stringify(confessions));
    
    // Check if this was the confession of the day
    const cotd = localStorage.getItem('confession_of_day');
    if (cotd === confessionId) {
        setConfessionOfDay();
    }
    
    if (reload) {
        loadConfessions();
        updateStatistics();
    }
 }
 
 function showRandomConfession() {
    if (isGlobalMode && firebaseInitialized) {
        showRandomGlobalConfession();
    } else {
        showRandomLocalConfession();
    }
 }
 
 // Show random global confession from Firebase
 async function showRandomGlobalConfession() {
     try {
         if (!window.firebaseServices) {
             throw new Error('Firebase services not available');
         }
         
         const { db, collection, getDocs, query, limit } = window.firebaseServices;
         
         // Create a reference to the confessions collection
         const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
         
         // Get a random count of confessions
         const countQuery = query(confessionsRef, limit(1));
         const countSnapshot = await getDocs(countQuery);
         
         // Check if we have any confessions
         if (countSnapshot.empty) {
             alert('No confessions available to show.');
             return;
         }
         
         // Get a random confession
         const randomLimit = Math.floor(Math.random() * 100) + 1; // Limit to 100 for performance
         const randomQuery = query(confessionsRef, limit(randomLimit));
         const randomSnapshot = await getDocs(randomQuery);
         
         if (randomSnapshot.empty) {
             alert('No confessions available to show.');
             return;
         }
         
         // Pick a random confession from the results
         const confessions = [];
         randomSnapshot.forEach((doc) => {
             confessions.push({
                 id: doc.id,
                 ...doc.data()
             });
         });
         
         const randomIndex = Math.floor(Math.random() * confessions.length);
         const randomConfession = confessions[randomIndex];
         
         // Increment view count
         incrementViewCount(randomConfession.id);
         
         // Find the confession in the current display and scroll to it
         setTimeout(() => {
             const confessionElement = document.querySelector(`[data-id="${randomConfession.id}"]`);
             if (confessionElement) {
                 confessionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 confessionElement.style.backgroundColor = 'var(--primary-light)';
                 setTimeout(() => {
                     confessionElement.style.backgroundColor = '';
                     confessionElement.style.transition = 'background-color 1s ease';
                 }, 2000);
             } else {
                 // If the confession is not in the current view, load it
                 loadGlobalConfessions().then(() => {
                    const element = document.querySelector(`[data-id="${randomConfession.id}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.style.backgroundColor = 'var(--primary-light)';
                        setTimeout(() => {
                            element.style.backgroundColor = '';
                            element.style.transition = 'background-color 1s ease';
                        }, 2000);
                    } else {
                        // Still couldn't find it, just reload
                        showErrorMessage('Could not display the random confession. Try again.');
                    }
                });
            }
        });
        
    } catch (error) {
        console.error("Error showing random global confession:", error);
        showErrorMessage('Error finding a random confession.');
        
        // Fallback to local random confession
        showRandomLocalConfession();
    }
}

function showRandomLocalConfession() {
   const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
   
   if (confessions.length === 0) {
       alert('No confessions available to show.');
       return;
   }
   
   const randomIndex = Math.floor(Math.random() * confessions.length);
   const randomConfession = confessions[randomIndex];
   
   incrementViewCount(randomConfession.id);
   
   // Find the page containing this confession
   const sortedConfessions = applyFilters(confessions);
   const confessionIndex = sortedConfessions.findIndex(c => c.id === randomConfession.id);
   const page = Math.floor(confessionIndex / CONFESSIONS_PER_PAGE) + 1;
   
   if (page !== currentPage) {
       changePage(page);
   }
   
   setTimeout(() => {
       const confessionElement = document.querySelector(`[data-id="${randomConfession.id}"]`);
       if (confessionElement) {
           confessionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
           confessionElement.style.backgroundColor = 'var(--primary-light)';
           setTimeout(() => {
               confessionElement.style.backgroundColor = '';
               confessionElement.style.transition = 'background-color 1s ease';
           }, 2000);
       }
   }, 300);
}

function setConfessionOfDay() {
   const now = new Date();
   const lastUpdate = localStorage.getItem('last_cotd_update');
   const lastUpdateDate = lastUpdate ? new Date(lastUpdate) : null;
   
   if (!lastUpdate || lastUpdateDate.toDateString() !== now.toDateString()) {
       if (isGlobalMode && firebaseInitialized) {
           setGlobalConfessionOfDay();
       } else {
           setLocalConfessionOfDay();
       }
   }
   
   displayConfessionOfDay();
}

// Set confession of the day from global confessions
async function setGlobalConfessionOfDay() {
    try {
        if (!window.firebaseServices) {
            throw new Error('Firebase services not available');
        }
        
        const { db, collection, getDocs, query, limit, orderBy } = window.firebaseServices;
        
        // Create a reference to the confessions collection
        const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
        
        // Get a popular confession
        const popularQuery = query(
            confessionsRef,
            orderBy('popularity', 'desc'),
            limit(10)
        );
        
        const querySnapshot = await getDocs(popularQuery);
        
        if (querySnapshot.empty) {
            // Fallback to local confession of the day
            setLocalConfessionOfDay();
            return;
        }
        
        // Get a random confession from the top 10 popular ones
        const confessions = [];
        querySnapshot.forEach((doc) => {
            confessions.push({
                id: doc.id
            });
        });
        
        const randomIndex = Math.floor(Math.random() * confessions.length);
        const cotdId = confessions[randomIndex].id;
        
        localStorage.setItem('confession_of_day', cotdId);
        localStorage.setItem('last_cotd_update', now.toISOString());
        
        console.log('Global confession of the day set:', cotdId);
    } catch (error) {
        console.error("Error setting global confession of the day:", error);
        
        // Fallback to local confession of the day
        setLocalConfessionOfDay();
    }
}

function setLocalConfessionOfDay() {
   const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
   
   if (confessions.length > 0) {
       const randomIndex = Math.floor(Math.random() * confessions.length);
       const cotdId = confessions[randomIndex].id;
       
       localStorage.setItem('confession_of_day', cotdId);
       localStorage.setItem('last_cotd_update', new Date().toISOString());
   } else {
       localStorage.removeItem('confession_of_day');
   }
}

function displayConfessionOfDay() {
   const cotdContainer = document.getElementById('confession-of-day-container');
   const cotdId = localStorage.getItem('confession_of_day');
   
   if (!cotdId) {
       cotdContainer.innerHTML = '';
       return;
   }
   
   const confession = getConfessionById(cotdId);
   
   if (!confession) {
       localStorage.removeItem('confession_of_day');
       setConfessionOfDay();
       return;
   }
   
   incrementViewCount(cotdId);
   
   const categoryBadge = confession.category ? 
       `<span class="category-badge" style="background-color: var(--primary-light); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block;">${confession.category}</span>` : '';
   
   // Global badge for confessions shared globally
   const globalBadge = confession.isGlobal ? 
       `<span class="global-badge">
           <i class="fas fa-globe"></i> Global
       </span>` : '';
   
   cotdContainer.innerHTML = `
       <div class="container">
           <h2><i class="fas fa-star"></i> Confession of the Day</h2>
           <div class="confession confession-of-day" data-id="${cotdId}">
               ${categoryBadge}
               <p>${confession.text}</p>
               <div class="meta">
                   <div class="meta-info">
                       <div class="timestamp">
                           <i class="far fa-clock"></i> ${formatDate(new Date(confession.timestamp))}
                           ${globalBadge}
                       </div>
                       <div class="views">
                           <i class="far fa-eye"></i> ${confession.views || 0} views
                       </div>
                   </div>
                   <div class="actions">
                       ${createReactionButtons(confession)}
                       <button class="tip-button" onclick="tipConfession('${cotdId}')">
                           <i class="fas fa-hand-holding-usd"></i> Tip
                       </button>
                       <button class="share-button" onclick="openShareOptions(event, '${cotdId}')">
                           <i class="fas fa-share-alt"></i>
                       </button>
                       <div class="share-options" id="share-options-${cotdId}">
                           <button class="share-option-btn" onclick="shareToTwitter('${cotdId}')">
                               <i class="fab fa-twitter"></i> Twitter
                           </button>
                           <button class="share-option-btn" onclick="copyShareLink('${cotdId}')">
                               <i class="fas fa-link"></i> Copy Link
                           </button>
                           <button class="share-option-btn" onclick="createShareCard('${cotdId}')">
                               <i class="fas fa-image"></i> Create Card
                           </button>
                       </div>
                   </div>
               </div>
           </div>
       </div>`;
}

function updateStatistics() {
   // Local stats
   const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
   const today = new Date();
   const todayConfessions = confessions.filter(c => {
       const confDate = new Date(c.timestamp);
       return confDate.toDateString() === today.toDateString();
   });
   
   if (isGlobalMode && firebaseInitialized) {
       // Get global stats from Firebase
       getGlobalStatistics().then(stats => {
           document.getElementById('total-confessions').textContent = stats.totalConfessions || 0;
           document.getElementById('today-confessions').textContent = stats.todayConfessions || 0;
           document.getElementById('active-users').textContent = stats.activeUsers || 0;
       }).catch(error => {
           console.error("Error getting global statistics:", error);
           
           // Fallback to local stats
           document.getElementById('total-confessions').textContent = confessions.length;
           document.getElementById('today-confessions').textContent = todayConfessions.length;
           document.getElementById('active-users').textContent = getLocalActiveUsers();
       });
   } else {
       // Use local stats
       document.getElementById('total-confessions').textContent = confessions.length;
       document.getElementById('today-confessions').textContent = todayConfessions.length;
       document.getElementById('active-users').textContent = getLocalActiveUsers();
   }
}

// Get global statistics from Firebase
async function getGlobalStatistics() {
    try {
        if (!window.firebaseServices) {
            throw new Error('Firebase services not available');
        }
        
        const { db, collection, getDocs, query, where, orderBy } = window.firebaseServices;
        
        // Create a reference to the confessions collection
        const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
        
        // Get total confessions count
        const totalQuery = query(confessionsRef, limit(1));
        const totalSnapshot = await getDocs(totalQuery);
        const totalConfessions = totalSnapshot.size; // This is not accurate for large collections
        
        // Get today's confessions count
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayQuery = query(
            confessionsRef,
            where('timestamp', '>=', today.toISOString())
        );
        const todaySnapshot = await getDocs(todayQuery);
        const todayConfessions = todaySnapshot.size;
        
        // Get active users count
        const usersRef = collection(db, FIREBASE_SETTINGS.userCollection);
        const usersQuery = query(usersRef, limit(1));
        const usersSnapshot = await getDocs(usersQuery);
        const activeUsers = usersSnapshot.size; // This is not accurate for large collections
        
        return {
            totalConfessions,
            todayConfessions,
            activeUsers
        };
    } catch (error) {
        console.error("Error getting global statistics:", error);
        throw error;
    }
}

function getLocalActiveUsers() {
   let activeUsers = 0;
   for (let i = 0; i < localStorage.length; i++) {
       const key = localStorage.key(i);
       if (key.startsWith('userData_')) {
           activeUsers++;
       }
   }
   return activeUsers;
}

function autoArchiveOldConfessions() {
   // Only archive local confessions
   if (isGlobalMode) return;
   
   const confessions = JSON.parse(localStorage.getItem('confessions')) || [];
   let archivedConfessions = JSON.parse(localStorage.getItem('archived_confessions')) || [];
   
   const now = new Date();
   const cutoffDate = new Date(now.getTime() - (AUTO_ARCHIVE_DAYS * 24 * 60 * 60 * 1000));
   
   const newConfessions = confessions.filter(confession => {
       const confessionDate = new Date(confession.timestamp);
       if (confessionDate < cutoffDate) {
           archivedConfessions.push(confession);
           return false;
       }
       return true;
   });
   
   if (newConfessions.length !== confessions.length) {
       localStorage.setItem('confessions', JSON.stringify(newConfessions));
       localStorage.setItem('archived_confessions', JSON.stringify(archivedConfessions));
       loadConfessions();
       
       // Check if confession of the day was archived
       const cotdId = localStorage.getItem('confession_of_day');
       if (cotdId && !newConfessions.some(c => c.id === cotdId)) {
           setConfessionOfDay();
       }
   }
}

function checkSharedConfession() {
   const urlParams = new URLSearchParams(window.location.search);
   const sharedConfessionId = urlParams.get('confession');
   
   if (sharedConfessionId) {
       incrementViewCount(sharedConfessionId);
       
       // Try to find the confession in local storage first
       let confession = getConfessionById(sharedConfessionId);
       
       if (confession) {
           // Found locally, highlight it
           highlightSharedConfession(sharedConfessionId);
       } else if (isGlobalMode && firebaseInitialized) {
           // Not found locally, try to fetch from Firebase
           fetchConfessionFromFirebase(sharedConfessionId).then(confession => {
               if (confession) {
                   // Save locally for future reference
                   saveConfessionLocally(confession);
                   
                   // Reload and highlight
                   if (isGlobalMode) {
                       loadGlobalConfessions().then(() => {
                           highlightSharedConfession(sharedConfessionId);
                       });
                   } else {
                       loadConfessions();
                       highlightSharedConfession(sharedConfessionId);
                   }
               } else {
                   showErrorMessage('The shared confession could not be found.');
               }
           }).catch(error => {
               console.error("Error fetching shared confession:", error);
               showErrorMessage('Error loading the shared confession.');
           });
       } else {
           showErrorMessage('The shared confession could not be found.');
       }
   }
}

// Fetch a specific confession from Firebase
async function fetchConfessionFromFirebase(confessionId) {
    try {
        if (!window.firebaseServices) {
            throw new Error('Firebase services not available');
        }
        
        const { db, doc, getDoc } = window.firebaseServices;
        
        // Get a reference to the confession document
        const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
        
        // Get the document
        const docSnap = await getDoc(confessionRef);
        
        if (docSnap.exists()) {
            return {
                id: docSnap.id,
                ...docSnap.data()
            };
        } else {
            return null;
        }
    } catch (error) {
        console.error("Error fetching confession from Firebase:", error);
        throw error;
    }
}

function highlightSharedConfession(confessionId) {
   setTimeout(() => {
       const confessionElement = document.querySelector(`[data-id="${confessionId}"]`);
       if (confessionElement) {
           confessionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
           confessionElement.style.backgroundColor = 'var(--primary-light)';
           setTimeout(() => {
               confessionElement.style.backgroundColor = '';
               confessionElement.style.transition = 'background-color 1s ease';
           }, 3000);
       }
   }, 500);
}

function incrementViewCount(confessionId) {
   try {
       if (isGlobalMode && firebaseInitialized) {
           incrementGlobalViewCount(confessionId);
       }
       
       // Always increment locally too for performance
       incrementLocalViewCount(confessionId);
   } catch (error) {
       console.error("Error incrementing view count:", error);
   }
}

// Increment view count in Firebase
async function incrementGlobalViewCount(confessionId) {
    try {
        if (!window.firebaseServices) {
            throw new Error('Firebase services not available');
        }
        
        const { db, doc, updateDoc, increment } = window.firebaseServices;
        
        // Get a reference to the confession document
        const confessionRef = doc(db, FIREBASE_SETTINGS.collection, confessionId);
        
        // Update the document with the incremented view count
        await updateDoc(confessionRef, {
            views: increment(1),
            popularity: increment(0.1) // Small popularity boost for views
        });
        
        console.log(`View count incremented for confession ${confessionId} in Firebase`);
    } catch (error) {
        console.error("Error incrementing global view count:", error);
        // Just continue with local increment, no need to show error
    }
}

function incrementLocalViewCount(confessionId) {
   let confessions = JSON.parse(localStorage.getItem('confessions')) || [];
   const confessionIndex = confessions.findIndex(c => c.id === confessionId);
   
   if (confessionIndex !== -1) {
       if (typeof confessions[confessionIndex].views !== 'number') {
           confessions[confessionIndex].views = 0;
       }
       
       confessions[confessionIndex].views++;
       localStorage.setItem('confessions', JSON.stringify(confessions));
       return confessions[confessionIndex].views;
   }
   return 0;
}

function handleSearch(e) {
   searchQuery = e.target.value;
   currentPage = 1;
   
   if (isGlobalMode) {
       loadGlobalConfessions();
   } else {
       loadConfessions();
   }
}

function handleSortChange(e) {
   currentSort = e.target.value;
   currentPage = 1;
   
   if (isGlobalMode) {
       loadGlobalConfessions();
   } else {
       loadConfessions();
   }
}

function handleCategoryFilterChange(e) {
   currentCategory = e.target.value;
   currentPage = 1;
   
   if (isGlobalMode) {
       loadGlobalConfessions();
   } else {
       loadConfessions();
   }
}

function handleAdminLogin() {
   const password = document.getElementById('admin-password').value;
   const adminPanel = document.getElementById('admin-panel');
   
   if (password === 'admin123') { // In production, use secure authentication
       adminPanel.style.display = 'block';
       document.getElementById('admin-password').value = '';
       document.body.classList.add('admin-mode');
       sessionStorage.setItem('isAdmin', 'true');
       
       // Show Firebase settings for admins
       document.getElementById('firebase-settings').style.display = 'block';
   } else {
       alert('Incorrect password');
   }
}

function clearAllConfessions() {
   if (confirm('Are you sure you want to clear all confessions? This action cannot be undone.')) {
       if (isGlobalMode && firebaseInitialized) {
           clearAllGlobalConfessions();
       } else {
           clearAllLocalConfessions();
       }
   }
}

// Clear all confessions from Firebase
async function clearAllGlobalConfessions() {
    try {
        if (!window.firebaseServices) {
            throw new Error('Firebase services not available');
        }
        
        const { db, collection, getDocs, deleteDoc, doc } = window.firebaseServices;
        
        // This is dangerous and should be protected by proper authentication in production
        if (!confirm('WARNING: This will delete ALL confessions from the global database. This action CANNOT be undone. Are you absolutely sure?')) {
            return;
        }
        
        // Create a reference to the confessions collection
        const confessionsRef = collection(db, FIREBASE_SETTINGS.collection);
        
        // Get all confessions
        const querySnapshot = await getDocs(confessionsRef);
        
        // Delete each confession
        const deletePromises = [];
        querySnapshot.forEach((docSnap) => {
            deletePromises.push(deleteDoc(doc(db, FIREBASE_SETTINGS.collection, docSnap.id)));
        });
        
        await Promise.all(deletePromises);
        
        console.log('All global confessions deleted');
        
        // Also clear local confessions
        clearAllLocalConfessions();
        
        // Refresh
        loadGlobalConfessions();
    } catch (error) {
        console.error("Error clearing all global confessions:", error);
        showErrorMessage('Error clearing global confessions. Try again or check your connection.');
    }
}

function clearAllLocalConfessions() {
   localStorage.removeItem('confessions');
   localStorage.removeItem('archived_confessions');
   localStorage.removeItem('confession_of_day');
   localStorage.removeItem('last_cotd_update');
   
   if (!isGlobalMode) {
       loadConfessions();
   }
   
   setConfessionOfDay();
   updateStatistics();
}

function downloadShareCard() {
   if (window.currentShareCardData && window.currentShareCardId) {
       const link = document.createElement('a');
       link.download = `confession-${window.currentShareCardId}.png`;
       link.href = window.currentShareCardData;
       link.click();
       
       // Close the modal after download
       closeShareCardModal();
   }
}

function closeShareCardModal() {
   const modal = document.getElementById('share-card-modal');
   modal.style.display = 'none';
   
   // Clean up stored data
   window.currentShareCardData = null;
   window.currentShareCardId = null;
}

// Sync User to Firebase - this function would be called when a user makes meaningful changes
async function syncUserToFirebase() {
    if (!isGlobalMode || !firebaseInitialized) return;
    
    try {
        if (!window.firebaseServices) {
            throw new Error('Firebase services not available');
        }
        
        const { db, doc, setDoc } = window.firebaseServices;
        
        // Get user data
        const userData = JSON.parse(localStorage.getItem('userData_' + userId)) || {
            karma: 0,
            achievements: []
        };
        
        // Add last synced timestamp
        userData.lastSynced = new Date().toISOString();
        
        // Get a reference to the user document
        const userRef = doc(db, FIREBASE_SETTINGS.userCollection, userId);
        
        // Update the document with the user data
        await setDoc(userRef, userData, { merge: true });
        
        console.log('User synced to Firebase');
    } catch (error) {
        console.error("Error syncing user to Firebase:", error);
    }
}
</script>
</body>
</html>
